//
//  HDStartAdverImageView.m
//  HDStock
//
//  Created by hd-app02 on 2017/1/17.
//  Copyright © 2017年 hd-app02. All rights reserved.
//

#import "HDStartAdverImageView.h"

@implementation HDStartAdverImageView

- (instancetype)initWithFrame:(CGRect)frame{

    if (self = [super initWithFrame:frame]) {
        
        NSArray * imageNameArray = @[@"startpage_ad", @"startpage_ad_2"];
        
        UIImage * image1 = imageNamed(imageNameArray[0]);
        UIImage * image2 = imageNamed(imageNameArray[1]);
        
        NSArray * imageArray = @[image1,image2];
        
        int r = arc4random() % [imageArray count];
        
        self.image = imageArray[r];
        self.tag = 1300 + r;
        
        self.userInteractionEnabled = YES;
        
        self.passButton = [[UIButton alloc]initWithFrame:CGRectMake(self.bounds.size.width - 70, 30.0f, 55, 23)];
        [self.passButton setTitle:@"05" forState:UIControlStateNormal];
        [self.passButton setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
        self.passButton.titleLabel.font = [UIFont systemFontOfSize:14];
        self.passButton.backgroundColor = [UIColor blackColor];
        self.passButton.alpha = 0.25;
        self.passButton.layer.masksToBounds = YES;
        self.passButton.layer.cornerRadius = 5.0f;
        [self.passButton addTarget:self action:@selector(buttonOnTouched:) forControlEvents:UIControlEventTouchUpInside];
    
        [self addSubview:self.passButton];
        
        UITapGestureRecognizer * tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(turnToAdverDetail)];
        
        tap.delegate = self;
        
        [self addGestureRecognizer:tap];
        
        [self setButtonTimer];
        
    }


    return self;

}

- (void)setButtonTimer{
    
    __block int timeout=5; //倒计时时间
    
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
    dispatch_source_t _timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0,queue);
    
    dispatch_source_set_timer(_timer,dispatch_walltime(NULL, 0),1.0*NSEC_PER_SEC, 0); //每秒执行
    
    dispatch_source_set_event_handler(_timer, ^{
        
        if(timeout<0){ //倒计时结束，关闭
            
            dispatch_source_cancel(_timer);
            
            dispatch_async(dispatch_get_main_queue(), ^{
                
                //设置界面的按钮显示 根据自己需求设置
                [self.delegate passToAnotherController];
                
            });
            
        }else{
            
            int seconds = timeout % 60;
            
            NSString *strTime = [NSString stringWithFormat:@"%.2d", seconds];
            
            dispatch_async(dispatch_get_main_queue(), ^{
                
                //设置界面的按钮显示 根据自己需求设置
                
                [self.passButton setTitle:[NSString stringWithFormat:@"%@",strTime] forState:UIControlStateNormal];
                
            });
            
            timeout--;
            
        }
        
    });
    
    dispatch_resume(_timer);
    
}

- (void)buttonOnTouched:(UIButton *)button{
    
    [self.delegate passToAnotherController];
    
}

- (void)turnToAdverDetail{

    [self.delegate turnIntoDetail];

}

- (BOOL)gestureRecognizer:(UIGestureRecognizer *)gestureRecognizer shouldReceiveTouch:(UITouch *)touch{

    if ([touch.view isKindOfClass:[UIButton class]]) {
        
        return NO;
        
    }
    
    return YES;

}

@end
