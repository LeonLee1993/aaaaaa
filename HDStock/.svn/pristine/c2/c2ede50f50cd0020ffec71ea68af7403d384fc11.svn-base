//
//  HDSearchCenterViewController.m
//  HDStock
//
//  Created by hd-app02 on 16/11/14.
//  Copyright © 2016年 hd-app02. All rights reserved.
//

#import "HDSearchCenterViewController.h"
#import "HDMarketSearchTF.h"
#import "HDSearchTableViewCell.h"
#import "HDSearchViewModel.h"
#import "DeleteHistoryTableViewCell.h"
#import "HDMarketDetailViewController.h"
#define realWidth [[UIScreen mainScreen] bounds].size.width
#define realHeight [[UIScreen mainScreen] bounds].size.height
@interface HDSearchCenterViewController ()<UITextFieldDelegate,UITableViewDelegate,UITableViewDataSource>
@property (nonatomic,strong)HDMarketSearchTF *HDsearchTextFd;
@property (nonatomic,strong)NSMutableArray *historyArr;
@property (nonatomic,strong)UITableView * tableView;
@property (nonatomic,strong)NSMutableArray *searchResultArr;
@end

@implementation HDSearchCenterViewController{
    BOOL _hasTextFlag;//文本框是否输入内容
    UILabel *titleLable;
}

-(NSMutableArray *)historyArr{
    if(!_historyArr){
        _historyArr = @[].mutableCopy;
    }
    return _historyArr;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setTopView];
    [self tempModel];
    [self setUpTableView];
    _hasTextFlag = NO;
}

- (void)tempModel{
    if(!_historyArr){
        _historyArr = @[].mutableCopy;
    }
    HDSearchViewModel * model1 = [[HDSearchViewModel alloc]init];
    model1.name = @"平安银行";
    model1.code = @"000001";
    model1.selected = @"no";
    
    HDSearchViewModel * model2 = [[HDSearchViewModel alloc]init];
    model2.name = @"平安银行";
    model2.code = @"000001";
    model2.selected = @"yes";
    
    [_historyArr addObject:model1];
    [_historyArr addObject:model2];
}

-(void)setUpTableView{
    _tableView = [[UITableView alloc]initWithFrame:CGRectMake(0, 64, realWidth, realHeight-64)];
    _tableView.backgroundColor = BACKGROUNDCOKOR;
    _tableView.delegate = self;
    _tableView.dataSource = self;
    _tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    [_tableView registerNib:[UINib nibWithNibName:@"HDSearchTableViewCell" bundle:nil] forCellReuseIdentifier:@"HDSearchTableViewCell"];
    [_tableView registerNib:[UINib nibWithNibName:@"DeleteHistoryTableViewCell" bundle:nil] forCellReuseIdentifier:@"DeleteHistoryTableViewCell"];
    [self.view addSubview:_tableView];
    [_tableView reloadData];
    NSLog(@"%@",_historyArr);
}

-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [self.navigationController setNavigationBarHidden:YES animated:YES];
}

- (void)viewWillDisappear:(BOOL)animated{

    [super viewWillDisappear:animated];
    [self.navigationController setNavigationBarHidden:NO];

}

- (void)setTopView{
    UIView *topView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, realWidth, 20)];
    [self.view addSubview:topView];
    topView.backgroundColor = RGBCOLOR(26, 120, 200);
    
    UIView *topSearchView = [[UIView alloc]initWithFrame:CGRectMake(0, 20, realWidth, 44)];
    [self.view addSubview:topSearchView];
    topSearchView.backgroundColor = RGBCOLOR(26, 120, 200);
    self.HDsearchTextFd = [[HDMarketSearchTF alloc]initWithFrame:CGRectMake(15, 7,self.view.frame.size.width-70,30)];
    self.HDsearchTextFd.placeholder = @"股票代码/全拼音/首字母";
    self.HDsearchTextFd.delegate = self;
    self.HDsearchTextFd.clearButtonMode = UITextFieldViewModeWhileEditing;
    self.HDsearchTextFd.layer.cornerRadius=6;
    self.HDsearchTextFd.layer.masksToBounds = YES;
    self.HDsearchTextFd.keyboardType = UIKeyboardTypeWebSearch;
    self.HDsearchTextFd.backgroundColor = BACKGROUNDCOKOR;
    UIImageView *img = [[UIImageView alloc]initWithImage:[UIImage imageNamed:@"sousuo"]];
    img.frame = CGRectMake(10, 0,13,14);
    self.HDsearchTextFd.textColor = UICOLOR(153, 153, 153, 1);
    self.HDsearchTextFd.leftView = img;
    self.HDsearchTextFd.leftViewMode = UITextFieldViewModeAlways;
    self.HDsearchTextFd.font = [UIFont fontWithName:@"Arial" size:13];
    self.HDsearchTextFd.tintColor = [UIColor grayColor];
    [topSearchView addSubview:self.HDsearchTextFd];
    UIButton *cancelBRT = [[UIButton alloc]initWithFrame:CGRectMake(realWidth-45, 5, 30, 15)];
    [cancelBRT setTitle:@"取消" forState:UIControlStateNormal];
    cancelBRT.tintColor = [UIColor whiteColor];
    cancelBRT.titleLabel.font = [UIFont systemFontOfSize:15];
    [cancelBRT sizeToFit];
    [cancelBRT addTarget:self action:@selector(backTo) forControlEvents:UIControlEventTouchUpInside];
    [topSearchView addSubview:cancelBRT];
  
    [self.HDsearchTextFd addTarget:self action:@selector(textField1TextChange:) forControlEvents:UIControlEventEditingChanged];
}

-(void)textField1TextChange:(UITextField *)textField{
    NSLog(@"textField1 - 输入框内容改变,当前内容为: %@",textField.text);
    if(textField.text.length>0){
        [self searchAction];
//        titleLable.text = @"搜索结果";
    }else{
        _hasTextFlag = NO;
//        titleLable.text = @"历史搜索";
        [_tableView reloadData];
    }
}

- (void)backTo{
    [self.navigationController popViewControllerAnimated:YES];
}


#pragma mark -----tableViewDataSource
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    //搜索文字框有字的时候
    if(_hasTextFlag){
        return 0;
    }
    //历史记录的时候
    else{
        if(section==0){
            return _historyArr.count;
        }
        else if (section==1){
            return 1;
        }
        else{
            return 0;
        }
    }
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    //搜索文字框有字的时候
    if(_hasTextFlag){
        return nil;
    }
    //历史记录的时候
    else{
        if(indexPath.section == 0){
            HDSearchTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@"HDSearchTableViewCell"];
            cell.selectionStyle = UITableViewCellSelectionStyleNone;
            cell.model = _historyArr[indexPath.row];
            cell.addBlock = ^(){
                NSLog(@"add to Market");
            };
            return cell;
        }else if (indexPath.section ==1){
            DeleteHistoryTableViewCell *deleteCell = [tableView dequeueReusableCellWithIdentifier:@"DeleteHistoryTableViewCell"];
            deleteCell.selectionStyle = UITableViewCellSelectionStyleNone;
            return deleteCell;
        }else{
            return nil;
        }
    }
}

-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    if(section==0){
        return 43;
    }else{
        return 0;
    }
}

-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    
    if(section ==0){
        UIView * tableHeadView = [[UIView alloc]initWithFrame:CGRectMake(0, 64, realWidth, 43)];
    //    tableHeadView.backgroundColor = UICOLOR(102, 102, 102, 1);
        tableHeadView.backgroundColor = BACKGROUNDCOKOR;
        titleLable = [[UILabel alloc]initWithFrame:CGRectMake(20, 15, 100, 13)];
        titleLable.textColor = UICOLOR(102, 102, 102, 1);
        titleLable.font = [UIFont systemFontOfSize:13];
        if(_hasTextFlag){
            titleLable.text = @"搜索结果";
        }else{
            titleLable.text = @"搜索历史";
        }
        titleLable.textAlignment = NSTextAlignmentLeft;
        [tableHeadView addSubview:titleLable];
        return tableHeadView;
    }else{
        return nil;
    }
}

-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    if(indexPath.section ==0){
        return 60;
    }
    else if (indexPath.section ==1){
        return 43;
    }
    else{
        return 0;
    }
}

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    //搜索文字框有字的时候
    if(_hasTextFlag){
        return 1;
    }
    //历史记录的时候
    else{
        return 2;
    }
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    if(indexPath.section ==0){
        HDMarketDetailViewController *detailVC = [[HDMarketDetailViewController alloc]init];
        UIBarButtonItem *barButtonItem = [[UIBarButtonItem alloc] initWithTitle:@"" style:UIBarButtonItemStyleDone target:nil action:nil];
        self.navigationItem.backBarButtonItem = barButtonItem;
        [self.navigationController pushViewController:detailVC animated:YES];
    }else if (indexPath.section ==1){
        
    }
}

- (void)searchAction{
    _hasTextFlag = YES;
    [_tableView reloadData];
}


@end
