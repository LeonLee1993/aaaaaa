//
//  HDLiveInerViewController.m
//  HDStock
//
//  Created by hd-app01 on 16/11/11.
//  Copyright © 2016年 hd-app02. All rights reserved.
//

#import "HDLiveInerViewController.h"
#import "HDLivePersonInfoViewController.h"
#import "HDLivePersonInfoViewController.h"
#import "HDLiveBoxViewController.h"
#import "HDGuPingViewController.h"
#import "HDLiveChateViewController.h"
#import "HDLiveLivingViewController.h"
//#import "HDLiveGuPingTableViewCell.h"



@interface HDLiveInerViewController ()<UITableViewDelegate,UITableViewDataSource,UIPageViewControllerDelegate>{
    CGFloat headerViewHeight;//透视图高度
    CGFloat selectionBarHeight;//直播，聊天选择栏高度
    UIImageView * headPicIMV;//头像
    UILabel * nickNameLab;//昵称
    UILabel * liveStatusLab;//直播状态
    UILabel * profileLab;//资格证书
    UIButton * personInfoBtn;//个人信息按钮
    UIView * moveLineView;//可移动横线
    UIView * _headBgView;//顶部个人信息背景视图
    NSArray * selectionArr;//直播，聊天标题数组
    CGFloat selectionBtnWidht;//直播，聊天按钮宽度
    CGFloat verLineViewWidth;//直播，聊天之间的竖线宽度
    CGFloat moveLineViewWidth;//可移动横线宽度
    CGFloat moveLineViewHeight;//可移动横线高度
    UIView * selectionBgView;
    UIScrollView * contentScrollView;//装子控制器的view
    NSMutableArray * childVCArr;//子控制器数组
    NSArray * vcArr;//装子控制器
    UIViewController * _currentVC;//当前显示的控制器
    
    
    
}
@property (nonatomic,strong) NSMutableArray * arr;

@end

@implementation HDLiveInerViewController

- (void) setUp {
    
    self.view.backgroundColor = UICOLOR(236, 237, 238, 1);
    
    vcArr = @[[HDLiveLivingViewController new],[HDLiveChateViewController new],[HDGuPingViewController new],[HDLiveBoxViewController new]];

    self.title = @"牛人直播";
    selectionArr = @[@"直播",@"聊天",@"股评",@"百宝箱"];
    headerViewHeight = 120.0f;
    selectionBarHeight = 50.0f*WIDTH;
    verLineViewWidth = 0.5;//竖线宽度
    selectionBtnWidht = (SCREEN_WIDTH-(selectionArr.count-1)*verLineViewWidth)/selectionArr.count;//直播按钮宽度
    moveLineViewWidth = selectionBtnWidht*7/9;//可移动的横线宽度
    moveLineViewHeight = 2;
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    [self setUp];
    [self createUI];
//    [self createTB];
    [self createChildVCs];
}

- (void) createUI {
    _headBgView = [self createHeaderView];
    _headBgView.userInteractionEnabled = YES;
    [self.view addSubview:_headBgView];
}

- (UIView *) createHeaderView {
    

    CGFloat leftSpace = 15.0f;
    CGFloat horBigSpace = 13.0f;
    CGFloat verBigSpace = 12.0f;
    CGFloat headPicIMVHeight = 70.0f;//头像高度
    CGFloat lineViewHeight = 0.3;//横线高度
    
    UIView * tempView = [[UIView alloc] initWithFrame:CGRM(0, NAV_STATUS_HEIGHT, SCREEN_WIDTH, headerViewHeight+selectionBarHeight+2)];
    tempView.userInteractionEnabled = YES;
    tempView.backgroundColor = COLOR(whiteColor);

    //头像
    headPicIMV = [[UIImageView alloc] initWithFrame:CGRM(leftSpace, (headerViewHeight)/2-headPicIMVHeight/2, headPicIMVHeight, headPicIMVHeight)];
    headPicIMV.image = imageNamed(@"weidenglu");
    headPicIMV.layer.cornerRadius = headPicIMVHeight/2;
    headPicIMV.layer.masksToBounds = YES;
    [tempView addSubview:headPicIMV];
    
    //昵称
    CGSize nickNameSize = [@"胜者为王" sizeWithAttributes:@{NSFontAttributeName:[UIFont systemFontOfSize:15]}];
    nickNameLab = [ZHFactory createLabelWithFrame:CGRM(CGRectGetMaxX(headPicIMV.frame)+horBigSpace*3/4, CGRectGetMidY(headPicIMV.frame)-nickNameSize.height*4/3-5, nickNameSize.width, nickNameSize.height+4) andFont:[UIFont systemFontOfSize:15] andTitleColor:TEXT_COLOR title:@"胜者为王"];
    nickNameLab.text = @"胜者为王";
    [tempView addSubview:nickNameLab];
    
    //直播状态
    CGSize liveSize = [@"直播中" sizeWithAttributes:@{NSFontAttributeName:[UIFont systemFontOfSize:13]}];
    liveStatusLab = [ZHFactory createLabelWithFrame:CGRM(CGRectGetMaxX(nickNameLab.frame)+2, CGRectGetMidY(nickNameLab.frame)-liveSize.height*5/4/2, liveSize.width*5/4, liveSize.height*5/4) andFont:[UIFont systemFontOfSize:13] andTitleColor:[UIColor whiteColor] title:@"直播中"];
    liveStatusLab.textAlignment = NSTextAlignmentCenter;
    liveStatusLab.backgroundColor = COLOR(redColor);
    liveStatusLab.layer.cornerRadius = CGRectGetHeight(liveStatusLab.frame)/2;
    liveStatusLab.layer.masksToBounds = YES;
    [tempView addSubview:liveStatusLab];
    
    //箭头
    CGFloat arrowIMVWidth = 16;
    UIImageView * arrowIMV = [[UIImageView alloc] initWithFrame:CGRM(SCREEN_WIDTH-horBigSpace-arrowIMVWidth, CGRectGetMidY(headPicIMV.frame)-arrowIMVWidth/2-3, arrowIMVWidth, arrowIMVWidth)];
    arrowIMV.image = imageNamed(@"into");
//    arrowIMV.backgroundColor = COLOR(redColor);
    [tempView addSubview:arrowIMV];
    
    //资格证
    CGSize leftProfileSize = [@"资格证号：" sizeWithAttributes:@{NSFontAttributeName:[UIFont systemFontOfSize:14]}];
    UILabel * leftProfileLabl = [ZHFactory createLabelWithFrame:CGRM(CGRectGetMinX(nickNameLab.frame), CGRectGetMaxY(nickNameLab.frame)+verBigSpace, leftProfileSize.width, CGRectGetHeight(nickNameLab.frame)) andFont:[UIFont systemFontOfSize:14] andTitleColor:[UIColor grayColor] title:@"资格证号:"];
    [tempView addSubview:leftProfileLabl];
    
    profileLab = [ZHFactory createLabelWithFrame:CGRM(CGRectGetMaxX(leftProfileLabl.frame), CGRectGetMinY(leftProfileLabl.frame), CGRectGetMinX(arrowIMV.frame)-3-CGRectGetMaxX(leftProfileLabl.frame), CGRectGetHeight(leftProfileLabl.frame)) andFont:[UIFont systemFontOfSize:14] andTitleColor:[UIColor grayColor] title:@"asssserueoi803543,每天一节课"];
    [tempView addSubview:profileLab];
    
    //个人信息按钮
    UIButton * headBtn = [UIButton buttonWithType:(UIButtonTypeCustom)];
    headBtn.frame = CGRM(0, 0, SCREEN_WIDTH, headerViewHeight-5);
    [headBtn addTarget:self action:@selector(headBtnClicked:) forControlEvents:(UIControlEventTouchUpInside)];
    headBtn.tag = 400;
    headBtn.backgroundColor = COLOR(clearColor);
    [tempView addSubview:headBtn];
    
    //横线
    UIView * tempLineView = [[UIView alloc] initWithFrame:CGRM(0, headerViewHeight, SCREEN_WIDTH, lineViewHeight)];
    tempLineView.backgroundColor = LINE_COLOR;
    [tempView addSubview:tempLineView];
    
    selectionBgView = [[UIView alloc] initWithFrame:CGRM(0, CGRectGetMaxY(tempLineView.frame), SCREEN_WIDTH, selectionBarHeight-lineViewHeight)];
    selectionBgView.userInteractionEnabled = YES;
    selectionBgView.backgroundColor = COLOR(whiteColor);
    selectionBgView.userInteractionEnabled = YES;
    [tempView addSubview:selectionBgView];
    
    //中间的headview
    CGSize selectionSize = [@"直播" sizeWithAttributes:@{NSFontAttributeName:[UIFont systemFontOfSize:17]}];
    for (int i = 0; i < selectionArr.count; i++) {
        UIButton * tempBtn = [ZHFactory createBtnWithFrame:CGRM((selectionBtnWidht+verLineViewWidth)*i, 0, selectionBtnWidht, CGRectGetHeight(selectionBgView.frame)-moveLineViewHeight) title:selectionArr[i] titleFont:[UIFont systemFontOfSize:17] titleCoclor:TEXT_COLOR bgColor:[UIColor whiteColor] cornerRadius:0.1];
        [tempBtn setTitleColor:UICOLOR(168, 123, 8, 1) forState:(UIControlStateSelected)];
        tempBtn.tag = 500+i;
        i == 0 ? (tempBtn.selected = YES):(tempBtn.selected = NO);
        
        [tempBtn addTarget:self action:@selector(tempBtnClicked:) forControlEvents:UIControlEventTouchUpInside];
        
        [selectionBgView addSubview:tempBtn];

        if (i < selectionArr.count-1) {
            UIView * tempVerLineView = [[UIView alloc] initWithFrame:CGRM(CGRectGetMaxX(tempBtn.frame), selectionBarHeight/2-selectionSize.height/2, verLineViewWidth, selectionSize.height)];
            tempVerLineView.backgroundColor = LINE_COLOR;
            [selectionBgView addSubview:tempVerLineView];
        }

        if (tempBtn.selected) {
            moveLineView = [UIView new];
            moveLineView.center = CGPointMake(CGRectGetMidX(tempBtn.frame), CGRectGetMaxY(tempBtn.frame)+1);
            moveLineView.bounds = CGRM(0, 0, moveLineViewWidth, moveLineViewHeight);
            moveLineView.backgroundColor = UICOLOR(168, 123, 8, 1);
            [selectionBgView addSubview:moveLineView];

        }
    }

    return tempView;
}

#pragma mark - 创建子控制器
- (void) createChildVCs {
    for (int i = 0; i < vcArr.count; i++) {
        [self addChildViewController:vcArr[i]];
        [[vcArr[i] view] setTag:600+i];
    }
    _currentVC = vcArr[0];
    [self fitFrameForChildViewController:vcArr[0]];
    [self.view addSubview:_currentVC.view];
}

- (void)fitFrameForChildViewController:(UIViewController *)chileViewController{
    UIView *subView = _currentVC.view;
    CGRect subViewFrame = _currentVC.view.frame;
    subViewFrame.origin.y = CGRectGetMaxY(_headBgView.frame)+1;
    subViewFrame.size.height = SCREEN_HEIGHT-TABBAR_HEIGHT-CGRectGetMaxY(_headBgView.frame)-1;
    subView.frame = subViewFrame;
}
#pragma mark - 点击事件
- (void) tempBtnClicked:(UIButton *)sender {//500+
    for (UIView * tempView in selectionBgView.subviews) {
        if ([tempView isKindOfClass:[UIButton class]]) {
            UIButton * tempBtn = (UIButton*)tempView;
            tempBtn.selected = NO;
        }
    }
    sender.selected = YES;
    [UIView animateWithDuration:0.3 animations:^{
        moveLineView.center = CGPointMake(CGRectGetMidX(sender.frame), CGRectGetMaxY(sender.frame)+1);
        moveLineView.bounds = CGRM(0, 0, moveLineViewWidth, moveLineViewHeight);
    }];
    
    if ((sender.tag == 500 && _currentVC == vcArr[0]) || (sender.tag == 501 && _currentVC == vcArr[1]) || (sender.tag == 502 && _currentVC == vcArr[2]) || (sender.tag == 503 && _currentVC == vcArr[3])) {
        return;
    }
    _currentVC = vcArr[sender.tag-500];
    switch (sender.tag) {
        case 500:{
            [self transitionFromOldViewController:_currentVC toNewViewController:vcArr[0]];
        }
            break;
        case 501:{
            [self transitionFromOldViewController:_currentVC toNewViewController:vcArr[1]];
        }
            break;
        case 502:{
            [self transitionFromOldViewController:_currentVC toNewViewController:vcArr[2]];
        }
            break;
        case 503:{
            [self transitionFromOldViewController:_currentVC toNewViewController:vcArr[3]];
        }
            break;
    }
    [self fitFrameForChildViewController:_currentVC];
}

//转换子视图控制器
- (void)transitionFromOldViewController:(UIViewController *)oldViewController toNewViewController:(UIViewController *)newViewController{
    [self transitionFromViewController:oldViewController toViewController:newViewController duration:0 options:UIViewAnimationOptionTransitionCrossDissolve animations:nil completion:^(BOOL finished) {
        if (finished) {
            [newViewController didMoveToParentViewController:self];
            _currentVC = newViewController;
        }else{
            _currentVC = oldViewController;
        }
        [self.view addSubview:_currentVC.view];
    }];
}

//个人信息点击事件
- (void) headBtnClicked:(UIButton *)sender {
    
    HDLivePersonInfoViewController * vc = [[HDLivePersonInfoViewController alloc] init];
    [self.navigationController pushViewController:vc animated:YES];
    
}
@end
