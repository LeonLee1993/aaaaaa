//
//  HDShareCustom.m
//  HDStock
//
//  Created by hd-app01 on 16/12/19.
//  Copyright © 2016年 hd-app02. All rights reserved.
//

#import "HDShareCustom.h"

#define shareBlakBgViewAlpha 0.3
#define kTransFromForScaleTimeInterVal 0.15
#define kSmallestValue 0.3
#define kBigestValue 1.0

@interface HDShareCustom(){
    int shareType;
    UILabel * titleL;
    UIButton * cancellBtn;
}
@end

@implementation HDShareCustom

static id _publishContent;//类方法中的全局变量这样用（类型前面加static）
static UIVisualEffectView * _effectView;
static UIView * _shareBlakBgView;
static UIView * _shareBgView;

+ (void) registShareSDK {
    /**
     *  设置ShareSDK的appKey，如果尚未在ShareSDK官网注册过App，请移步到http://mob.com/login 登录后台进行应用注册
     *  在将生成的AppKey传入到此方法中。
     *  方法中的第二个第三个参数为需要连接社交平台SDK时触发，
     *  在此事件中写入连接代码。第四个参数则为配置本地社交平台时触发，根据返回的平台类型来配置平台信息。
     *  如果您使用的时服务端托管平台信息时，第二、四项参数可以传入nil，第三项参数则根据服务端托管平台来决定要连接的社交SDK。
     */
    [ShareSDK registerApp:SHARE_APPKEY
     
          activePlatforms:@[
                            @(SSDKPlatformTypeSinaWeibo),
                            @(SSDKPlatformTypeWechat),
                            @(SSDKPlatformTypeQQ)]
                 onImport:^(SSDKPlatformType platformType)
     {
         switch (platformType)
         {
             case SSDKPlatformTypeWechat:
                 [ShareSDKConnector connectWeChat:[WXApi class]];
                 break;
             case SSDKPlatformTypeQQ:
                 [ShareSDKConnector connectQQ:[QQApiInterface class] tencentOAuthClass:[TencentOAuth class]];
                 break;
             case SSDKPlatformTypeSinaWeibo:
                 [ShareSDKConnector connectWeibo:[WeiboSDK class]];
                 break;
             default:
                 break;
         }
     }
          onConfiguration:^(SSDKPlatformType platformType, NSMutableDictionary *appInfo)
     {
         
         switch (platformType)
         {
             case SSDKPlatformTypeSinaWeibo:
                 //设置新浪微博应用信息,其中authType设置为使用SSO＋Web形式授权
                 [appInfo SSDKSetupSinaWeiboByAppKey:@"2150087076"
                                           appSecret:@"fff114df6427749e222765c873c013ef"
                                         redirectUri:@"http://open.weibo.com/apps/2150087076/privilege/oauth"
                                            authType:SSDKAuthTypeBoth];
                 break;
             case SSDKPlatformTypeWechat:
                 [appInfo SSDKSetupWeChatByAppId:@"wx817e33d58fcd8194"
                                       appSecret:@"a6a6d463da5fea19cb7d9ba38f2ef75d"];
                 break;
             case SSDKPlatformTypeQQ:
                 [appInfo SSDKSetupQQByAppId:@"1105894722"
                                      appKey:@"ifc3705adGcEsbrd"
                                    authType:SSDKAuthTypeBoth];
                 break;
             default:
                 break;
         }
     }];
}

-(void)createShareUI {
    if (_isHasCreatedShareUIBool) {
        [self addUI];
        NSLog(@"已创建分享界面，直接添加");
    }else {
        NSArray * shareIconArr = @[imageNamed(@"share_weixin"),imageNamed(@"share_friendCircle"),imageNamed(@"share_weibo"),imageNamed(@"share_QQ")];
        
        NSArray * shareTitleArr = @[@"微信好友",@"微信朋友圈",@"新浪微博",@"QQ"];
        //    _publishContent = publishContent;
        UIWindow *window = [UIApplication sharedApplication].keyWindow;
        //分享黑色背景视图
        _shareBlakBgView = [UIView new];
        _shareBlakBgView.backgroundColor = UICOLOR(28, 28, 28, 1);
        _shareBlakBgView.alpha = shareBlakBgViewAlpha;
        _shareBlakBgView.tag = 8800;
        [window addSubview:_shareBlakBgView];
        
        UITapGestureRecognizer * tap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(shareBlakBgViewTapEvent:)];
        [_shareBlakBgView addGestureRecognizer:tap];
        [window addSubview:_shareBlakBgView];
        
        //分享白色背景视图
        _shareBgView = [UIView new];
        _shareBgView.backgroundColor = [UIColor colorWithHexString:@"#F9F9F9"];
        _shareBgView.tag = 8900;
        [window addSubview:_shareBgView];
        
        //分享至
        titleL = [ZHFactory createLabelWithFrame:CGRectZero andFont:systemFont(16) andTitleColor:[UIColor colorWithHexString:@"#333333"] title:@"分享至"];
        titleL.textAlignment = NSTextAlignmentCenter;
        titleL.backgroundColor = COLOR(whiteColor);
        [_shareBgView addSubview:titleL];
        
        //分享按钮
        for (int i = 0; i < shareTitleArr.count; i++) {
            //icon
            UIImageView * shareIMV = [[UIImageView alloc] init];
            shareIMV.image = shareIconArr[i];
            shareIMV.tag = 920+i;
            [_shareBgView addSubview:shareIMV];
            
            UIButton * shareBtn = [UIButton buttonWithType:(UIButtonTypeCustom)];
            shareBtn.tag = 900+i;
            [shareBtn addTarget:self action:@selector(shareBtnClicked:) forControlEvents:(UIControlEventTouchUpInside)];
            [_shareBgView addSubview:shareBtn];
        }
        
        cancellBtn = [UIButton buttonWithType:(UIButtonTypeCustom)];
        [cancellBtn setImage:imageNamed(@"share_cancell") forState:(UIControlStateNormal)];
        [cancellBtn addTarget:self action:@selector(cancellBtnClicked:) forControlEvents:(UIControlEventTouchUpInside)];
        [_shareBgView addSubview:cancellBtn];
        
        [self adjustFrameWithtitleArr:shareTitleArr];
        self.isHasCreatedShareUIBool = YES;
    }
    self.isClosedShareUIBool = NO;
}
- (void) adjustFrameWithtitleArr:(NSArray *)shareTitleArr {
    
    CGFloat shareBgViewWidth = 280*WIDTH;
    CGFloat shareBgViewHeight = 156*WIDTH;
    CGFloat iconIMVWidth = 38.0*WIDTH;//分享图标宽度
    CGFloat titleLHeight = 40*WIDTH;
    CGFloat sectionWidth = shareBgViewWidth/shareTitleArr.count;
    CGFloat shareLineHeight = (shareBgViewHeight-titleLHeight)*3/5;
    CGFloat cancellBtnWidth = 28*WIDTH;
    
    _shareBlakBgView.frame = CGRM(0, 0, SCREEN_SIZE_WIDTH, SCREEN_SIZE_HEIGHT);
    _shareBgView.frame = CGRM(SCREEN_SIZE_WIDTH_HALF-shareBgViewWidth/2, SCREEN_HEIGHT/2-shareBgViewHeight/2, shareBgViewWidth, shareBgViewHeight);

    titleL.frame = CGRM(0, 0, shareBgViewWidth, titleLHeight);

    for (int i = 0; i < shareTitleArr.count; i++) {
        //分享图标
        UIImageView * imv = (UIImageView*)[_shareBgView viewWithTag:920+i];
        imv.frame = CGRM((sectionWidth)*i+(sectionWidth/2.0-iconIMVWidth/2.0),CGMAX_Y(titleL.frame)+shareLineHeight/2-iconIMVWidth/2,iconIMVWidth, iconIMVWidth);
        
        //分享图标点击按钮
        UIButton * btn = (UIButton*)[_shareBgView viewWithTag:900+i];
        btn.frame = CGRM((sectionWidth)*i, CGMAX_Y(titleL.frame), sectionWidth, shareLineHeight);
//        btn.backgroundColor = COLOR(redColor);
        
    }
    cancellBtn.frame = CGRM(shareBgViewWidth/2-cancellBtnWidth/2, titleLHeight+shareLineHeight+shareLineHeight*2.0/3/2-cancellBtnWidth/2, cancellBtnWidth, cancellBtnWidth);
    
    //添加启动动画
    [self addAnimScale];
    
}
//添加启动动画
- (void) addAnimScale {
    [UIView animateWithDuration:kTransFromForScaleTimeInterVal animations:^{
        _shareBlakBgView.alpha = shareBlakBgViewAlpha;
    }];
    
    _shareBgView.transform = CGAffineTransformMakeScale(0.01, 0.01);
    
    [UIView animateWithDuration:kTransFromForScaleTimeInterVal animations:^{
        
        _shareBgView.transform = CGAffineTransformMakeScale(1, 1);
        _shareBgView.alpha = 1;
        
    }completion:^(BOOL finish){
        
        
    }];
//    dispatch_time_t time = dispatch_time(DISPATCH_TIME_NOW, kTransFromForScaleTimeInterVal/2.0);
//    dispatch_after(time, dispatch_get_main_queue(), ^{
//        [UIView animateWithDuration:kTransFromForScaleTimeInterVal animations:^{
//            _shareBgView.alpha = 1;
//        }];
//    });
//    CABasicAnimation *animation2 = [CABasicAnimation animationWithKeyPath:@"transform.scale"];
//    animation2.fromValue = [NSValue valueWithCGPoint:CGPointMake(kSmallestValue, kSmallestValue)];
//    animation2.toValue = [NSValue valueWithCGPoint:CGPointMake(kBigestValue, kBigestValue)];
//    animation2.duration = kTransFromForScaleTimeInterVal;//不设置时候的话，有一个默认的缩放时间.
//    animation2.removedOnCompletion = NO;
//    animation2.fillMode = kCAFillModeForwards;
//    [_shareBgView.layer addAnimation:animation2 forKey:nil];
    
}
//取消按钮点击事件
- (void) cancellBtnClicked:(UIButton*)sender {
    [self dismiss];
    if ([self shareCustomDlegate] && [[self shareCustomDlegate] respondsToSelector:@selector(shareBlcakBgViewTaped)]) {
        [[self shareCustomDlegate] shareBlcakBgViewTaped];
    }
}
//分享黑色背景点击事件
- (void)shareBlakBgViewTapEvent:(UITapGestureRecognizer *)tap {
    [self dismiss];
    if ([self shareCustomDlegate] && [[self shareCustomDlegate] respondsToSelector:@selector(shareBlcakBgViewTaped)]) {
        [[self shareCustomDlegate] shareBlcakBgViewTaped];
    }
}
//分享按钮点击事件
- (void) shareBtnClicked:(UIButton*)sender {
    
    [self dismiss];
    if (self.comFromIndex == 0 && self.shareCustomDlegate && [self.shareCustomDlegate respondsToSelector:@selector(shareCustomShareBtnClicked)]) {
        [self.shareCustomDlegate shareCustomShareBtnClicked];
    }
    
    shareType = 0;
    switch (sender.tag) {
        case 900:
        {//微信好友
            shareType = SSDKPlatformSubTypeWechatSession;
            NSLog(@" 微信好友");
        }
            break;
            
        case 901:
        {//微信朋友圈
            shareType = SSDKPlatformSubTypeWechatTimeline;
            NSLog(@" 微信朋友圈");
        }
            break;
            
        case 902:
        {//新浪微博
            shareType = SSDKPlatformTypeSinaWeibo ;
            NSLog(@" 新浪微博");
        }
            break;
            
        case 903:
        {//QQ好友
            shareType = SSDKPlatformSubTypeQQFriend;
            NSLog(@" QQ好友");
        }
            break;
                         
        default:
            break;
    }
    
    BOOL isCanOpenWXBool = false;
    BOOL isCanOpenQQBool = false;
    BOOL isSinaWeiBoBool = false;
    
    if (sender.tag == 900 || sender.tag == 901)
    {//微信
        // 检测是否安装了微信
        if ([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:@"weixin://"]]) {
            
            isCanOpenWXBool = YES;
            if (self.sharePlatBlock) {
                self.sharePlatBlock(sender.tag-900);
            }
        }else {
            isCanOpenWXBool = NO;
            if (self.isInstalledAlertBlock) {
                self.isInstalledAlertBlock(@"没有安装微信");
            }
        }
    }else if (sender.tag == 903)
    {//QQ
        //判断是否安装了QQ
        if ([[UIApplication sharedApplication] canOpenURL:[NSURL URLWithString:@"mqq://"]]) {
            isCanOpenQQBool = YES;
            if (self.sharePlatBlock) {
                self.sharePlatBlock(sender.tag-900);
            }
        }else {
            isCanOpenQQBool = NO;
            if (self.isInstalledAlertBlock) {
                self.isInstalledAlertBlock(@"没有安装QQ");
            }
        }
    }else
    {//微博
        isSinaWeiBoBool = YES;
        if (self.sharePlatBlock) {
            self.sharePlatBlock(sender.tag-900);
        }
    }
}
- (void) gotoShareWithContent:(id)publishContent {
    //调用shareSDK的无UI分享类型
    WEAK_SELF;
    [ShareSDK share:shareType parameters:publishContent onStateChanged:^(SSDKResponseState state, NSDictionary *userData, SSDKContentEntity *contentEntity, NSError *error) {
        STRONG_SELF;

        if (strongSelf.shareStatusBlock) {
            strongSelf.shareStatusBlock(state);
        }
    }];
}
//取消分享界面
- (void)dismiss {
    
//    CABasicAnimation *animation2 = [CABasicAnimation animationWithKeyPath:@"transform.scale"];
//    animation2.toValue = [NSValue valueWithCGPoint:CGPointMake(kSmallestValue, kSmallestValue)];
//    animation2.duration = kTransFromForScaleTimeInterVal;//不设置时候的话，有一个默认的缩放时间.
//    animation2.removedOnCompletion = NO;
//    animation2.fillMode = kCAFillModeForwards;
//    [_shareBgView.layer addAnimation:animation2 forKey:nil];
    [UIView animateWithDuration:kTransFromForScaleTimeInterVal animations:^{
        
        _shareBgView.transform = CGAffineTransformMakeScale(0.1, 0.1);

    }completion:^(BOOL finish){
        
        
    }];
    
    dispatch_time_t time = dispatch_time(DISPATCH_TIME_NOW, kTransFromForScaleTimeInterVal);
    dispatch_after(time, dispatch_get_main_queue(), ^{
        [UIView animateWithDuration:kTransFromForScaleTimeInterVal animations:^{
            _shareBgView.alpha = 0;
            _shareBlakBgView.alpha = 0;
        }];
    });
    
    self.isClosedShareUIBool = YES;
}
//添加分享界面
- (void) addUI {
    [self addAnimScale];
}

//- (void)dismiss {
//    
//    [_shareBlakBgView removeFromSuperview];
//    [_shareBgView removeFromSuperview];
//
//    [UIView animateWithDuration:0.3 animations:^{
//        _shareBgView.frame = CGRM(SCREEN_SIZE_WIDTH_HALF, SCREEN_HEIGHT/2, 0, 0);
//
//    }];
//    
//    self.isClosedShareUIBool = YES;
//}
//
//- (void) addUI {
//    
//    CGFloat shareBgViewWidth = 280*WIDTH;
//    CGFloat shareBgViewHeight = 156*WIDTH;
//    
//    UIWindow *window = [UIApplication sharedApplication].keyWindow;
//    [window addSubview:_shareBlakBgView];
//    [window addSubview:_shareBgView];
//    
////    NSArray * shareTitleArr = @[@"微信好友",@"微信朋友圈",@"新浪微博",@"QQ"];
////
////    [UIView animateWithDuration:0.2 animations:^{
////        [self adjustFrameWithtitleArr:shareTitleArr];
////    }];
//    
//}

@end
