//
//  PCRegisterTelViewController.m
//  HDStock
//
//  Created by liyancheng on 16/12/5.
//  Copyright © 2016年 hd-app02. All rights reserved.
//

#import "PCRegisterTelViewController.h"
#import "PCRegisterPwordViewController.h"

#define getCode @"http://test.cdtzb.com/api.php?mod=member&act=note&mobile=%@&type=%@&test=1%d"

@interface PCRegisterTelViewController ()
@property (nonatomic, strong) NSTimer *Timer;//倒计时
@property (nonatomic, assign) int countdown;
@end

@implementation PCRegisterTelViewController{
    NSString *_vertify;
    NSDictionary *dic;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setHeader:@""];
    [_telNumTF becomeFirstResponder];
}

-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [self.navigationController setNavigationBarHidden:YES animated:NO];
}

- (IBAction)nextStepButton:(id)sender {
    PCRegisterPwordViewController * PWVC = [[PCRegisterPwordViewController alloc]init];
    if(_vertify.length>0){
        PWVC.codeStr = _vertify;
        PWVC.telStr = _telNumTF.text;
        PWVC.dic = dic;
        [self.navigationController pushViewController:PWVC animated:YES];
        PWVC.block = ^{
            [self backToPresentView];
        };
    }else{
        MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.label.text = @"请填写您的信息";
        [hud hideAnimated:YES afterDelay: 1];
    }
}

- (void)setHeader:(NSString *)titleStr{
    UIView *headView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 64)];
    headView.backgroundColor = RGBCOLOR(25,121,202);
    [self.view addSubview:headView];
    
    UILabel *titleLabel = [[UILabel alloc]initWithFrame:CGRectMake(SCREEN_WIDTH/2-100, 34, 200, 18)];
    [headView addSubview:titleLabel];
    titleLabel.font = [UIFont systemFontOfSize:17];
    titleLabel.text = titleStr;
    titleLabel.textColor = [UIColor whiteColor];
    titleLabel.textAlignment = NSTextAlignmentCenter;
    
    UIView *backToView = [[UIView alloc]initWithFrame:CGRectMake(0, 20, 100, 44)];
    backToView.backgroundColor = [UIColor clearColor];
    [headView addSubview:backToView];
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(backToPresentView)];
    UIImageView * backImage = [[UIImageView alloc]initWithFrame:CGRectMake(10, 13, 12, 19)];
    backImage.image = [UIImage imageNamed:@"back_icon"];
    [backToView addSubview:backImage];
    [backToView addGestureRecognizer:tap];
}

- (IBAction)getSCodeButtonClicked:(UIButton *)sender {
    _vertifyButton.userInteractionEnabled = NO;
    _countdown = 30;
    [self requestCode];
    sender.layer.borderColor = [UIColor grayColor].CGColor;
    [sender setTitleColor:[UIColor grayColor] forState:UIControlStateNormal];
    sender.titleLabel.text =[NSString stringWithFormat:@" 重新获取(30秒) "];
    [sender setTitle:@" 重新获取(30秒) " forState:UIControlStateNormal];
    _Timer = [NSTimer scheduledTimerWithTimeInterval:1 target:self selector:@selector(countDown) userInfo:nil repeats:YES];

}

- (void)requestCode{

    NSString * url = [NSString stringWithFormat:getCode,_telNumTF.text,@"register",arc4random()%10000];

    [[CDAFNetWork sharedMyManager]get:url params:nil success:^(id json) {
//        NSLog(@"%@",NSStringFromClass(json[@"code"]));
        if([json[@"code"] isEqual:@(1)]){
            dic = json[@"data"][0];
            _vertify = [NSString stringWithFormat:@"%@",dic[@"verify"]];
            NSLog(@"%@",_vertify);
            _SCodeTF.text = _vertify;
        }else{
            _vertifyButton.userInteractionEnabled = YES;
            [_vertifyButton setTitle:@" 获取验证码 " forState:UIControlStateNormal];
            MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
            hud.mode = MBProgressHUDModeText;
            hud.label.text = @"获取验证码失败";
            [hud hideAnimated:YES afterDelay:1];
            [_vertifyButton setTitle:@" 获取验证码 " forState:UIControlStateNormal];
            _vertifyButton.userInteractionEnabled = YES;
        }
        
    } failure:^(NSError *error) {
        NSLog(@"%@",error);
        MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.label.text = @"您的网络不给力!";
        [hud hideAnimated:YES afterDelay: 2];
    }];
}


- (void)countDown{
    _countdown --;
    _vertifyButton.titleLabel.text =[NSString stringWithFormat:@" 重新获取(%d秒) ",_countdown];
    [_vertifyButton setTitle:[NSString stringWithFormat:@" 重新获取(%d秒) ",_countdown] forState:UIControlStateNormal];
    if (_countdown == 0) {
        [_Timer invalidate];
        [_vertifyButton setTitle:@" 获取验证码 " forState:UIControlStateNormal];
        _vertifyButton.userInteractionEnabled = YES;
        _vertifyButton.layer.borderColor = RGBCOLOR(26, 121, 202).CGColor;
        [_vertifyButton setTitleColor:RGBCOLOR(26, 121, 202) forState:UIControlStateNormal];
    }
}

- (void)backToPresentView{
    self.block();
    [self dismissViewControllerAnimated:YES completion:nil];
}

@end
