//
//  HDMarketViewController.m
//  HDStock
//
//  Created HD liyancheng on 16/11/22.
//  Copyright © 2016年 hd-app02. All rights reserved.
//

#import "HDMarketViewController.h"
#import "HDSearchCenterViewController.h"
#import "HDMarketSearchTF.h"
#import "HDMarketMainTableViewCell.h"
#import "HDMarketDetailViewController.h"
#import "marketListModel.h"
@interface HDMarketViewController ()<UITableViewDelegate,UITableViewDataSource>
@property (nonatomic,strong) UITableView *tableView1;
@end

@implementation HDMarketViewController{
    BOOL hasSelectedStock;
    //添加自选股按钮
    UIButton * addButton;
    NSMutableArray *dataArr;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self setOriginData];
    //设置导航条
    [self setNavigation];
    //设置添加自选股按钮
//    [self setAddButton];
    [self setTableView];
    [self setTopView];
    [self loadDataOfProductList];
    
}

- (void)setTopView{
    UIView *topView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 42)];
    [self.view addSubview:topView];
    topView.backgroundColor = RGBCOLOR(243, 243, 243);
    NSArray *titleArr = @[@"股票名称",@"最新价",@"涨跌幅"];
    for (int i=0; i<3; i++) {
        UIView *view = [[UIView alloc]initWithFrame:CGRectMake(i*SCREEN_WIDTH/3, 0, SCREEN_WIDTH/3, 42)];
        [topView addSubview:view];
        UILabel * label = [[UILabel alloc]init];
        label.text = titleArr[i];
        label.font = [UIFont systemFontOfSize:13];
        label.textColor = RGBCOLOR(51, 51, 51);
        [label sizeToFit];
        label.center = view.center;
        [topView addSubview:label];
        UIImageView *image = [[UIImageView alloc]initWithFrame:CGRectMake(CGRectGetMaxX(label.frame), CGRectGetMaxY(label.frame)-6, 6, 6)];
        [topView addSubview:image];
        if(i!=0){
            image.image = [UIImage imageNamed:@""];
        }
    }
}

- (void)setOriginData{
    hasSelectedStock = NO;//初始化为NO 没有自选股
}


- (void)setAddButton{
    CGFloat resize = [[UIScreen mainScreen] bounds].size.width/375;
    CGFloat widthOfScreen = [[UIScreen mainScreen] bounds].size.width;
    
    addButton = [[UIButton alloc]initWithFrame:CGRectMake(widthOfScreen/2-52.5*resize, 240*resize, 105*resize, 105*resize)];
    [addButton setBackgroundImage:[UIImage imageNamed:@"add"] forState:UIControlStateNormal];
    [addButton addTarget:self action:@selector(jumpToSearchView) forControlEvents:UIControlEventTouchUpInside];
    
    if(hasSelectedStock){
        addButton.hidden = YES;
    }
    
    [self.view addSubview:addButton];
}

- (void)jumpToSearchView{
    
    HDSearchCenterViewController * vc = [[HDSearchCenterViewController alloc]init];
    
    [self.navigationController pushViewController:vc animated:NO];
    
}

- (void)setNavigation{
    self.title = @"行情";
}

//搜索按钮点击时
- (IBAction)searchButtonClicked:(id)sender {
    
    [self jumpToSearchView];
    
}


- (void)setTableView{
    if(!dataArr){
        dataArr = @[].mutableCopy;
    }
    if(!_tableView1){
        _tableView1 = [[UITableView alloc]init];
    }
    self.tableView1.delegate = self;
    self.tableView1.dataSource = self;
    self.tableView1.backgroundColor = RGBCOLOR(243, 243, 243);
    self.tableView1.separatorStyle = UITableViewCellSeparatorStyleNone;
    [self.tableView1 registerNib:[UINib nibWithNibName:@"HDMarketMainTableViewCell" bundle:nil] forCellReuseIdentifier:@"HDMarketMainTableViewCell"];
    self.tableView1.frame = CGRectMake(0, 42, SCREEN_WIDTH, SCREEN_HEIGHT-64-42);
    [self.view addSubview:_tableView1];
    WEAK_SELF;
    self.tableView1.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^{
        [dataArr removeAllObjects];
        [weakSelf loadDataOfProductList];
    }];
    self.tableView1.mj_footer = [MJRefreshBackNormalFooter footerWithRefreshingBlock:^{
        //因为没分页 所以全删
        [dataArr removeAllObjects];
        [weakSelf loadDataOfProductList];
    }];
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return dataArr.count;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    HDMarketMainTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@"HDMarketMainTableViewCell"];
    cell.model = dataArr[indexPath.row];
    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    return cell;
}

-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return 60*SCREEN_WIDTH/375;
}


-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    marketListModel *model =dataArr[indexPath.row];
    HDMarketDetailViewController *detail = [[HDMarketDetailViewController alloc]init];
    detail.codeStr = model.Symbol;
    [self.navigationController pushViewController:detail animated:YES];
}

- (void)loadDataOfProductList{
    
    NSString * url = [NSString stringWithFormat:MarketDefaultListURL];
    WEAK_SELF;
    STRONG_SELF;
    
    [[CDAFNetWork sharedMyManager]post:url params:nil success:^(id json) {
//        if([json[@"data"] isKindOfClass:[NSNull class]]||[json[@"data"] isKindOfClass:[NSString class]]){
//            MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:strongSelf.view animated:YES];
//            hud.mode = MBProgressHUDModeText;
//            hud.label.text = @"没有更多数据了";
//            [hud hideAnimated:YES afterDelay: 1];
//            [self endRefresh];
//        }else{
            for (NSDictionary *dic in json) {
                marketListModel * model = [marketListModel yy_modelWithDictionary:dic];
                [dataArr addObject:model];
            }
            dispatch_async(dispatch_get_main_queue(), ^{
                [self.tableView1 reloadData];
            });
            [self endRefresh];
//        }
    } failure:^(NSError *error) {
        [self endRefresh];
        MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:strongSelf.view animated:YES];
        hud.mode = MBProgressHUDModeText;
        hud.label.text = @"您的网络不给力!";
        [hud hideAnimated:YES afterDelay: 2];
    }];
}

-(void)endRefresh{
    [self.tableView1.mj_header endRefreshing];
    [self.tableView1.mj_footer endRefreshing];
}

@end
