//
//  HDHomePageViewController.m
//  HDStock
//  flag
//  Created by hd-app02 on 16/11/9.
//  Copyright © 2016年 hd-app02. All rights reserved.
//

#import "HDHomePageViewController.h"
#import "AppDelegate.h"
//左视图
#import "HDLeftMainViewController.h"

@interface HDHomePageViewController ()<UITableViewDataSource,UITableViewDelegate,PSYScrollButtonsDelegate,PSYScrollButtonViewsDelegate, UIApplicationDelegate, SDCycleScrollViewDelegate>

@property (weak, nonatomic) IBOutlet UITableView *mainTableView;
@property (nonatomic, strong) NSMutableArray * headLinedataArray;
@property (nonatomic, strong) NSMutableArray * bannerImageArray;
@property (nonatomic, strong) NSMutableArray * bannerDataArray;
@property (nonatomic, strong) NSMutableArray * hotNewsArray;
@property (nonatomic, strong) NSMutableArray * stockSayingArray;
@property (nonatomic, strong) NSString * token;

@end

@implementation HDHomePageViewController{

    NSInteger page;

    NSInteger perpage;
    
    NSInteger cateId;

}


- (NSMutableArray *)headLinedataArray{

    if (!_headLinedataArray) {
        
        _headLinedataArray = [[NSMutableArray alloc]init];
    }

    return _headLinedataArray;

}

- (NSMutableArray *)bannerImageArray{

    if (!_bannerImageArray) {
        _bannerImageArray = [[NSMutableArray alloc]init];
    }

    return _bannerImageArray;
}

- (NSMutableArray *)bannerDataArray{

    if (!_bannerDataArray) {
        _bannerDataArray = [[NSMutableArray alloc]init];
    }
    
    return _bannerDataArray;


}

- (NSMutableArray *)hotNewsArray{

    if (!_hotNewsArray) {
        _hotNewsArray = [[NSMutableArray alloc]init];
    }
    
    return _hotNewsArray;

}

- (NSMutableArray *)stockSayingArray{

    if (!_stockSayingArray) {
        _stockSayingArray = [[NSMutableArray alloc]init];
    }
    
    return _stockSayingArray;
    
}

- (void)viewDidDisappear:(BOOL)animated{

    [super viewDidDisappear:animated];
    
    NSIndexPath * index = [NSIndexPath indexPathForRow:0 inSection:3];

    HDStockSayingCell * cell = [self.mainTableView cellForRowAtIndexPath:index];
    
    [cell playerPause];

}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    NSDictionary *dicd = [[LYCUserManager informationDefaultUser] getUserInfoDic];
    
    if (dicd[@"token"]) {
        
        self.token = dicd[@"token"];
        
    }else{
    
        self.token = @"1";
    
    }
    
    page = 1;
    
    perpage = 20;
    
    cateId = 1;
    
    [self requestData];
    [self requestBannerImage];
    [self requestHotNewsData];
    [self requestStockSayingData];
    [self setUpTableView];
   
}

- (void)setUpTableView{

    _mainTableView.dataSource = self;
    
    _mainTableView.delegate = self;
    
    _mainTableView.backgroundColor = BACKGROUNDCOKOR;
    
    _mainTableView.allowsSelection = YES;
    
    [_mainTableView registerNib:[UINib nibWithNibName:@"HDTopScrollCell" bundle:nil] forCellReuseIdentifier:@"HDTopScrollCell"];
    [_mainTableView registerNib:[UINib nibWithNibName:@"HDMiddleCell" bundle:nil] forCellReuseIdentifier:@"HDMiddleCell"];
    
    [self.mainTableView registerNib:[UINib nibWithNibName:@"HDHeadLineBaseCell" bundle:nil] forCellReuseIdentifier:@"HDHeadLineBaseCell"];
    [self.mainTableView registerNib:[UINib nibWithNibName:@"HDHeadLineSingleViewCell" bundle:nil] forCellReuseIdentifier:@"HDHeadLineSingleViewCell"];
    [self.mainTableView registerNib:[UINib nibWithNibName:@"HDHeadLineBigViewCellCell" bundle:nil] forCellReuseIdentifier:@"HDHeadLineBigViewCellCell"];
    [self.mainTableView registerNib:[UINib nibWithNibName:@"HDHeadLineThreeViewCellCell" bundle:nil] forCellReuseIdentifier:@"HDHeadLineThreeViewCellCell"];
    [self.mainTableView registerNib:[UINib nibWithNibName:@"HDScrollWordsTableViewCell" bundle:nil] forCellReuseIdentifier:@"HDScrollWordsTableViewCell"];
    [self.mainTableView registerNib:[UINib nibWithNibName:@"HDStockSayingCell" bundle:nil] forCellReuseIdentifier:@"HDStockSayingCell"];
    
    WEAK_SELF;
    
    self.mainTableView.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^{
       
        page = 1;
        [weakSelf requestData];
        [weakSelf requestBannerImage];
        [weakSelf requestHotNewsData];
        [weakSelf requestStockSayingData];
        
    }];
    
    self.mainTableView.mj_footer = [MJRefreshBackNormalFooter footerWithRefreshingBlock:^{
        
        page ++;
        
        [weakSelf requestData];
        
    }];
    
}

#pragma mark === tableview data source

- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{

    return 5;

}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{

    if (section == 4) {
        
        if (self.headLinedataArray.count != 0) {
            
            return self.headLinedataArray.count;
            
        }

    }
    
    return 1;

}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{

    switch (indexPath.section) {
        case 0:
            return HDTopCellHeight;
            break;
        case 1:
            return HDScrollWordsCellHeight;
            break;
        case 2:
        {
            if (kScreenIphone4 || kScreenIphone5) {
                
                return HDMiddleCellHeight + 40;
                
            }else{
                
                return HDMiddleCellHeight;
                
            }
            
        }
            break;
        case 3:
        {
            if (kScreenIphone4 || kScreenIphone5) {
                
                return HDStockSayingCellHeight + 40;
                
            }else{
            
                return HDStockSayingCellHeight;
            
            }
        
        }
            
            break;
        case 4:
            
                if (self.headLinedataArray.count == 0) {
                    
                    return SCREEN_HEIGHT;
                }else{
                
                HDHeadLineModel * model = [self.headLinedataArray objectAtIndexCheck:indexPath.row];
                return model.cellHeight;
                }
                
            break;
            
        default:
            break;
    }
    
    return 0;

}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    
    switch (indexPath.section) {
            
        case 0:{
            
            HDTopScrollCell * cell = [_mainTableView dequeueReusableCellWithIdentifier:@"HDTopScrollCell"];
            
            cell.ScrollView.delegate = self;
            cell.imageUrlArray = self.bannerImageArray;
            cell.topScrollButtons.delegate = self;
            
            return cell;
        }
            break;
        case 1:{
            
            HDScrollWordsTableViewCell * cell = [_mainTableView dequeueReusableCellWithIdentifier:@"HDScrollWordsTableViewCell"];
            cell.wordsScorllView.delegate = self;
            
            NSMutableArray * muArray = [NSMutableArray new];
            
            for (HDHotNewsModel * model in self.hotNewsArray) {
             
            NSString * str = model.title;
                
                [muArray addObject:str];
            }
            
            cell.hotNewsArray = muArray;
            
            return cell;
            
        }
            break;
            
        case 2:{
            
            HDMiddleCell * cell = [_mainTableView dequeueReusableCellWithIdentifier:@"HDMiddleCell"];
            
            cell.psyScrollButtonView.delegate = self;
            
            return cell;
            
        }
            break;
        case 3:{
            
            HDStockSayingCell * cell = [_mainTableView dequeueReusableCellWithIdentifier:@"HDStockSayingCell"];
            cell.urlArray = self.stockSayingArray;
            return cell;
            
        }
            break;
        
        case 4:
                
                if (_headLinedataArray.count != 0) {
                
                HDHeadLineModel * headlineModel = [self.headLinedataArray objectAtIndexCheck:indexPath.row];
                
                HDHeadLineBaseCell * cellBase = [tableView dequeueReusableCellWithIdentifier:@"HDHeadLineBaseCell"];
                cellBase.model = headlineModel;
                
                HDHeadLineSingleViewCell * cellSingle = [tableView dequeueReusableCellWithIdentifier:@"HDHeadLineSingleViewCell"];
                cellSingle.model = headlineModel;
                
                
                HDHeadLineBigViewCellCell * cellBig = [tableView dequeueReusableCellWithIdentifier:@"HDHeadLineBigViewCellCell"];
                cellBig.model = headlineModel;
                
                HDHeadLineThreeViewCellCell * cellThreeView = [tableView dequeueReusableCellWithIdentifier:@"HDHeadLineThreeViewCellCell"];
                cellThreeView.model = headlineModel;
                
                    if(headlineModel.pic.length > 1){
                        
                        if (!headlineModel.countmanypic) {
                            
                            return cellSingle;
                            
                        }
                        if (headlineModel.countmanypic) {
                            
                            if (headlineModel.countmanypic == 1) {
                                
                                return cellSingle;
                                
                            }else if (headlineModel.countmanypic == 2){
                                
                                return cellBig;
                                
                            }else if (headlineModel.countmanypic == 3){
                                
                                return cellThreeView;
                                
                            }
                        }
                    }
                    if (headlineModel.pic.length == 0) {
                        
                        if (!headlineModel.countmanypic) {
                            
                            return cellBase;
                        }
                        
                        if (headlineModel.countmanypic) {
                            if (headlineModel.countmanypic == 1) {
                                
                                return  cellSingle;
                                
                            }else if (headlineModel.countmanypic == 2){
                                
                                return cellBig;
                                
                            }else if (headlineModel.countmanypic == 3){
                                
                                return cellThreeView;
                                
                            }
                        }
                    }
                }else{
                
                    UITableViewCell * cell = [_mainTableView dequeueReusableCellWithIdentifier:@"cell1"];
                    
                    if (!cell) {
                        
                        cell = [[UITableViewCell alloc]initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@"cell1"];
                    }
                    
                    return cell;
                
                }
        
            break;
        default:
            break;
    }

    return nil;
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    
    if (section == 4) {
        
        return 40;
        
    }
    return 0;
    
}

- (UIView *) tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section {
    
    if (section == 4) {
        
        HDHeaderView * view = [[HDHeaderView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 40)];
        
        return view;
        
    }
    
    return nil;
}

-(BOOL)tableView:(UITableView *)tableView shouldHighlightRowAtIndexPath:(NSIndexPath *)indexPath{
    
    if (indexPath.section == 4 && self.headLinedataArray.count != 0) {
        return YES;
    }
    
    return NO;
    
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    
    HDHeadLineModel * model = [self.headLinedataArray objectAtIndexCheck:indexPath.row];
    
    HeadLineViewController * headVC = [[HeadLineViewController alloc]init];
    
    headVC.hidesBottomBarWhenPushed = YES;
    
    headVC.aid = model.aid;
    headVC.uid = model.uid;
    
    [self.navigationController pushViewController:headVC animated:NO];
    
    
}

#pragma mark ==== 点击事件

- (void)cycleScrollView:(SDCycleScrollView *)cycleScrollView didSelectItemAtIndex:(NSInteger)index{
    
    NSLog(@"第%lu张图片被点击",(unsigned long)index);
    
    Class class = cycleScrollView.superview.superview.class;
    
    HDAdvertisementModel * model = [self.bannerDataArray objectAtIndexCheck:index];
    HDHotNewsModel * hotModel = [self.hotNewsArray objectAtIndexCheck:index];
    
    if (class == [HDScrollWordsTableViewCell class] ) {
        
        HeadLineViewController * headVC = [[HeadLineViewController alloc]init];
        
        headVC.hidesBottomBarWhenPushed = YES;
        
        headVC.aid = hotModel.aid;
//        headVC.uid = model.uid;
        if (hotModel.aid) {
            [self.navigationController pushViewController:headVC animated:NO];
        }
        
        
    }else{
        HDAdversementDetailViewController * headVC = [[HDAdversementDetailViewController alloc]init];
        
        headVC.hidesBottomBarWhenPushed = YES;
    
        headVC.url = model.link;
        
        [self.navigationController pushViewController:headVC animated:NO];
    
    }

}

- (void)psySimpleButtonOnTouched:(UIButton *)button{
    
    NSLog(@"%ld",(long)button.tag);
    
    HDStockNavigationController * infoNav = self.tabBarController.childViewControllers[2];
    HDStockNavigationController * liveNav = self.tabBarController.childViewControllers[3];
    HDStockNavigationController * hqNav = self.tabBarController.childViewControllers[1];
    HDInfoMationViewController * infoVC = infoNav.childViewControllers[0];
    
    switch (button.tag) {
        case 1000:
            infoVC.selectedVC = 0;
            infoVC.fromwhere = @"资讯";
            [self.tabBarController setSelectedViewController:infoNav];
            break;
        case 1001:
            [self.tabBarController setSelectedViewController:hqNav];
            break;
        case 1002:
            [self.mainTableView scrollToRow:0 inSection:3 atScrollPosition:UITableViewScrollPositionTop animated:NO];
            break;
        case 1003:
        {
            HDStockCenterNavigationController * nav = [[UIStoryboard storyboardWithName:@"Main" bundle:nil]instantiateViewControllerWithIdentifier:@"HDStockCenterNavigationController"];
            [self presentViewController:nav animated:NO completion:nil];
        }
            break;
        case 1004:
            
            infoVC.selectedVC = 2;
            infoVC.fromwhere = @"学技巧";
            
            [self.tabBarController setSelectedViewController:infoNav];
            break;
        case 1005:
        {
            PSYPopOutView * pop = [[PSYPopOutView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT)];
           
            [self.view.window addSubview:pop];
            
        }
            break;
        case 1006:
            [self.tabBarController setSelectedViewController:liveNav];
            break;
        case 1007:
        {
            HDGetGoldenStock * pop = [[HDGetGoldenStock alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT)];
            
            [self.view.window addSubview:pop];
            
        }
            break;
            
        default:
            break;
    }
    
}

- (void)psyScrollButtonOnTouched:(UIButton *)button{

    ProductDetailViewController *PDVC = [[ProductDetailViewController alloc]init];
    switch (button.tag) {
        case 1100:
            PDVC.title = @"X6尊享版";
            PDVC.urlStr = @"http://gk.cdtzb.com/api/product/x6";
            PDVC.priceStr = @"998";
            break;
        case 1101:
            PDVC.title = @"擒牛";
            PDVC.urlStr = @"http://gk.cdtzb.com/api/product/qn";
            PDVC.priceStr = @"1998";
            break;
        case 1102:
            PDVC.title = @"降龙";
            PDVC.urlStr = @"http://gk.cdtzb.com/api/product/xl";
            PDVC.priceStr = @"3998";
            break;
        case 1103:
            PDVC.title = @"捉妖";
            PDVC.urlStr = @"http://gk.cdtzb.com/api/product/zy";
            PDVC.priceStr = @"5998";
            break;
            
        default:
            break;
    }

    
    [self.navigationController pushViewController:PDVC animated:NO];

}

#pragma mark - 网络请求
- (void)requestData{
    
    NSString * url = [NSString stringWithFormat:Home_HeadLineCateNews,(long)page,(long)perpage,(long)cateId,self.token,arc4random()%10000];
    NSLog(@"首页资讯%@",url);
    [self.headLinedataArray removeAllObjects];
    WEAK_SELF;
    //1.获取一个全局串行队列
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
    dispatch_async(queue, ^{
        
        STRONG_SELF;
        
        [[CDAFNetWork sharedMyManager]get:url params:nil success:^(id json) {
            
            NSArray * dataArr = json[@"data"];
            if (dataArr.count < perpage) {
                
                [strongSelf.mainTableView.mj_footer endRefreshingWithNoMoreData];
                
            }else{
                
                [strongSelf endRefresh];
                
            }
            if (1 == page) { // 说明是在重新请求数据.
                
                [strongSelf.headLinedataArray removeAllObjects];
            }
            
            
            for (NSDictionary * dic in dataArr) {
                
                HDHeadLineModel * headlinemodel = [HDHeadLineModel yy_modelWithDictionary:dic];
                
                [strongSelf.headLinedataArray addObject:headlinemodel];
                
            }
            
            dispatch_async(dispatch_get_main_queue(), ^{
                
                [strongSelf.mainTableView reloadData];
                
            });
            
        } failure:^(NSError *error) {
            
            [strongSelf endRefresh];
            
            MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:strongSelf.view animated:YES];
            hud.mode = MBProgressHUDModeText;
            hud.label.text = @"您的网络不给力!";
            [hud hideAnimated:YES afterDelay: 2];
            
        }];
        
    });
    
    
    
}

- (void)requestBannerImage{

    NSString * bannerUrl = [NSString stringWithFormat:Advertisement,1,arc4random()%10000];
    
    NSLog(@"广告图片%@",bannerUrl);
    WEAK_SELF;
    //1.获取一个全局串行队列
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
    dispatch_async(queue, ^{
        
        STRONG_SELF;
        
        [[CDAFNetWork sharedMyManager]get:bannerUrl params:nil success:^(id json) {
            [self.bannerDataArray removeAllObjects];
             [self.bannerImageArray removeAllObjects];
            NSArray * array = json[@"data"];
            
            for (NSDictionary * dic in array) {
                
                HDAdvertisementModel * adModel = [HDAdvertisementModel yy_modelWithDictionary:dic];
                
                [self.bannerDataArray addObject:adModel];
                
                NSString * str = dic[@"url"];
                [strongSelf.bannerImageArray addObject:str];
            
            }
            
            dispatch_async(dispatch_get_main_queue(), ^{
                
                [strongSelf.mainTableView reloadData];
                
            });
            
        } failure:^(NSError *error) {
            
        }];
        
    });


}

- (void)requestHotNewsData{
    
    NSString * hotNewsUrl = [NSString stringWithFormat:Home_HotNews,arc4random()%10000];
    
    WEAK_SELF;
    //1.获取一个全局串行队列
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
    dispatch_async(queue, ^{
        
        STRONG_SELF;
        
        [[CDAFNetWork sharedMyManager]get:hotNewsUrl params:nil success:^(id json) {
            [self.hotNewsArray removeAllObjects];
            NSArray * array = json[@"data"];
            
            for (NSDictionary * dic in array) {
                
                HDHotNewsModel * adModel = [HDHotNewsModel yy_modelWithDictionary:dic];

                [strongSelf.hotNewsArray addObject:adModel];
                
            }
            
            dispatch_async(dispatch_get_main_queue(), ^{
                
                [strongSelf.mainTableView reloadData];
                
            });
            
        } failure:^(NSError *error) {
            
        }];
        
    });
    
    
}

- (void)requestStockSayingData{
    
    NSString * stockSayingUrl = [NSString stringWithFormat:Home_HeadLineCateNews,1,5,28,self.token,arc4random()%10000];
    
    WEAK_SELF;
    //1.获取一个全局串行队列
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
    dispatch_async(queue, ^{
        
        STRONG_SELF;
        
        [[CDAFNetWork sharedMyManager]get:stockSayingUrl params:nil success:^(id json) {
            
            [self.stockSayingArray removeAllObjects];
            NSArray * dataArr = json[@"data"];
            
            for (NSDictionary * dic in dataArr) {
                
                HDHeadLineModel * headlinemodel = [HDHeadLineModel yy_modelWithDictionary:dic];
                
                [strongSelf.stockSayingArray addObject:headlinemodel];
                
            }
            
            dispatch_async(dispatch_get_main_queue(), ^{
                
                [strongSelf.mainTableView reloadData];
                
            });

            
        } failure:^(NSError *error) {
            
        }];
        
    });
    
    
}



#pragma mark--刷新进度条显示
//停止刷新
-(void)endRefresh{
    
    [self.mainTableView.mj_header endRefreshing];
    [self.mainTableView.mj_footer endRefreshing];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

#pragma mark ---左视图逻辑

#if 1
- (IBAction)personalCenterButtonOntouched:(UIButton *)sender {
    
    AppDelegate *tempDelegate = (AppDelegate *)[[UIApplication sharedApplication] delegate];

    if (tempDelegate.leftSideVc.sideClosed) {
        [tempDelegate.leftSideVc openLeftView];
    }else {
        [tempDelegate.leftSideVc closeLeftView];
    }
}


- (IBAction)searchItemOntouched:(UIButton *)sender {
    
    HDSearchCenterViewController * vc = [[HDSearchCenterViewController alloc]init];
    
    [self.navigationController pushViewController:vc animated:NO];
    
    
}

#endif



@end
