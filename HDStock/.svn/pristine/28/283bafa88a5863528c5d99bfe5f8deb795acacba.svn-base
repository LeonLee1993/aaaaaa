//
//  HDInformationController.m
//  HDStock
//
//  Created by hd-app02 on 2016/11/24.
//  Copyright © 2016年 hd-app02. All rights reserved.
//

#import "HDInformationController.h"
#import "HDRecommendViewController.h"

#define headViewHeight [UIScreen mainScreen].bounds.size.width * 95 / 207

static CGFloat const segmentViewHeight = 44.0;
static CGFloat const naviBarHeight = 64.0;

NSString *const ZJParentTableViewDidLeaveFromTopNotification = @"ZJParentTableViewDidLeaveFromTopNotification";
NSString *const FatherControllerIsRefreshing = @"FatherControllerIsRefreshing";

static NSString * const cellID = @"cellID";
static NSString * const kMyInfoArr = @"myInfoArr";

@interface HDCustomGestureTableView : UITableView

@end

@implementation HDCustomGestureTableView

/// 返回YES同时识别多个手势
- (BOOL)gestureRecognizer:(UIGestureRecognizer *)gestureRecognizer shouldRecognizeSimultaneouslyWithGestureRecognizer:(UIGestureRecognizer *)otherGestureRecognizer {
    return [gestureRecognizer isKindOfClass:[UIPanGestureRecognizer class]] && [otherGestureRecognizer isKindOfClass:[UIPanGestureRecognizer class]];
}

@end

@interface HDInformationController ()<ZJScrollPageViewDelegate, UIScrollViewDelegate, UITableViewDelegate, UITableViewDataSource, ATCarouselViewDelegate, HDPageViewControllerDelegate>

@property (strong, nonatomic) NSMutableArray<NSString *> *titles;
@property (strong, nonatomic) UIView *containerView;
@property (strong, nonatomic) ZJScrollSegmentView *segmentView;
@property (strong, nonatomic) ZJContentView *contentView;
@property (strong, nonatomic) ATCarouselView *headView;
@property (strong, nonatomic) UIScrollView *childScrollView;
@property (strong, nonatomic) HDCustomGestureTableView *tableView;

@property (nonatomic,strong) NSMutableArray * selectedLabsArr;

@end

@implementation HDInformationController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.automaticallyAdjustsScrollViewInsets = NO;
    [self.view addSubview:self.tableView];
    
    __weak typeof(self) weakself = self;
    
    /// 下拉刷新
    self.tableView.mj_header = [MJRefreshNormalHeader headerWithRefreshingBlock:^{
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            typeof(weakself) strongSelf = weakself;
            [strongSelf.tableView.mj_header endRefreshing];
        });
    }];
    
    self.tableView.mj_footer = [MJRefreshBackNormalFooter footerWithRefreshingBlock:^{
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            typeof(weakself) strongSelf = weakself;
            [strongSelf.tableView.mj_footer endRefreshing];
        });
        
        
    }];

    
    
}


#pragma ZJScrollPageViewDelegate 代理方法
- (NSInteger)numberOfChildViewControllers {
    return self.titles.count;
}

- (UIViewController<ZJScrollPageViewChildVcDelegate> *)childViewController:(UIViewController<ZJScrollPageViewChildVcDelegate> *)reuseViewController forIndex:(NSInteger)index {
    UIViewController<ZJScrollPageViewChildVcDelegate> *childVc = reuseViewController;
    
    if (!childVc) {
        
        childVc = [[HDRecommendViewController alloc] init];
        HDRecommendViewController *vc = (HDRecommendViewController *)childVc;
        vc.delegate = self;
        if ([self.segmentView.titles[index] isEqualToString:@"推荐"]) {
            vc.index = 9000;
        }else if ([self.segmentView.titles[index] isEqualToString:@"要闻"]) {
            vc.index = 9001;
        }else if ([self.segmentView.titles[index] isEqualToString:@"7*24小时"]) {
            vc.index = 9002;
        }else if ([self.segmentView.titles[index] isEqualToString:@"日历"]) {
            vc.index = 9003;
        }else if ([self.segmentView.titles[index] isEqualToString:@"板块"]) {
            vc.index = 9004;
        }else if ([self.segmentView.titles[index] isEqualToString:@"外围"]) {
            vc.index = 9005;
        }else if ([self.segmentView.titles[index] isEqualToString:@"个股"]) {
            vc.index = 9006;
        }else if ([self.segmentView.titles[index] isEqualToString:@"大盘"]) {
            vc.index = 9007;
        }
    
        }
    
    return childVc;
}


#pragma mark- ZJPageViewControllerDelegate

- (void)scrollViewIsScrolling:(UIScrollView *)scrollView {
    
    _childScrollView = scrollView;

    if (self.tableView.contentOffset.y < headViewHeight) {
        scrollView.contentOffset = CGPointZero;
        scrollView.showsVerticalScrollIndicator = NO;
    }else {
        self.tableView.contentOffset = CGPointMake(0.0f, headViewHeight);
        scrollView.showsVerticalScrollIndicator = NO;
    }

    
}

#pragma mark- UIScrollViewDelegate

- (void)scrollViewDidScroll:(UIScrollView *)scrollView {
    
    if (self.childScrollView && _childScrollView.contentOffset.y > 0) {
        self.tableView.contentOffset = CGPointMake(0.0f, headViewHeight);
    }
    CGFloat offsetY = scrollView.contentOffset.y;
    if(offsetY < headViewHeight) {
        [[NSNotificationCenter defaultCenter] postNotificationName:ZJParentTableViewDidLeaveFromTopNotification object:nil];
        
    }

    
}

#pragma mark- UITableViewDelegate, UITableViewDataSource

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return 1;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    UITableViewCell * cell = [tableView dequeueReusableCellWithIdentifier:cellID];
    
    if (cell == nil) {
        cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:cellID];
    }
    
    [cell.contentView.subviews makeObjectsPerformSelector:@selector(removeFromSuperview)];
    [cell.contentView addSubview:self.contentView];
    
    return cell;
}


- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section {
    return self.segmentView;
}


#pragma mark- setter getter
- (ZJScrollSegmentView *)segmentView {
    if (_segmentView == nil) {
        ZJSegmentStyle *style = [[ZJSegmentStyle alloc] init];

        style.showExtraButton = YES;
        
        style.autoAdjustTitlesWidth = YES;
        
        //    /** 设置附加按钮的背景图片 默认为nil*/
        style.extraBtnBackgroundImageName = @"+";
        
        //    /** 标题的字体 默认为14 */
        style.titleFont = [UIFont systemFontOfSize:16];
        
        style.segmentViewBounces = NO;
        
        style.selectedTitleColor = MAIN_COLOR;
        
        
        
        // 注意: 一定要避免循环引用!!
        __weak typeof(self) weakSelf = self;
        ZJScrollSegmentView *segment = [[ZJScrollSegmentView alloc] initWithFrame:CGRectMake(0, naviBarHeight + headViewHeight, self.view.bounds.size.width, segmentViewHeight) segmentStyle:style delegate:self titles:self.titles titleDidClick:^(ZJTitleView *titleView, NSInteger index) {
            
            [weakSelf.contentView setContentOffSet:CGPointMake(weakSelf.contentView.bounds.size.width * index, 0.0) animated:YES];
            
        }];
        segment.backgroundColor = BACKGROUNDCOKOR;
        _segmentView = segment;
        
        _segmentView.extraBtnOnClick = ^(UIButton * button){
            
            [button addTarget:weakSelf action:@selector(onclick:) forControlEvents:UIControlEventTouchUpInside];
            
        };
        
    }
    return _segmentView;
}

- (ZJContentView *)contentView {
    if (_contentView == nil) {
        ZJContentView *content = [[ZJContentView alloc] initWithFrame:self.view.bounds segmentView:self.segmentView parentViewController:self delegate:self];
        _contentView = content;
    }
    return _contentView;
}

- (ATCarouselView *)headView {
    if (!_headView) {
        _headView = [[ATCarouselView alloc] initWithFrame:CGRectMake(0, 0, self.view.bounds.size.width, headViewHeight)];
        _headView.delegate = self;
        _headView.images = @[imageNamed(@"111"),imageNamed(@"222"),imageNamed(@"333")];
    }
    
    return _headView;
}

- (HDCustomGestureTableView *)tableView {
    if (!_tableView) {
        CGRect frame = CGRectMake(0.0f, 0.0f, self.view.bounds.size.width, self.view.bounds.size.height);
        HDCustomGestureTableView *tableView = [[HDCustomGestureTableView alloc] initWithFrame:frame style:UITableViewStylePlain];
        // 设置tableView的headView
        tableView.tableHeaderView = self.headView;
        tableView.tableFooterView = [UIView new];
        // 设置cell行高为contentView的高度
        tableView.rowHeight = self.contentView.bounds.size.height;
        tableView.delegate = self;
        tableView.dataSource = self;
        // 设置tableView的sectionHeadHeight为segmentViewHeight
        tableView.sectionHeaderHeight = segmentViewHeight;
        tableView.showsVerticalScrollIndicator = false;
        
        _tableView = tableView;
    }
    
    return _tableView;
}

//跳转到添加标签页面
- (void)onclick:(UIButton *)button{
    
    ZXMyInfoViewController * addInfoVC = [[ZXMyInfoViewController alloc] init];
    addInfoVC.hidesBottomBarWhenPushed = YES;
    
    WEAK_SELF;
    addInfoVC.infoBlcok = ^(NSArray * selectedInfoArr)  {
        //获取选中的资讯数组
        STRONG_SELF;
        [strongSelf.selectedLabsArr removeAllObjects];
        [strongSelf.selectedLabsArr addObjectsFromArray:selectedInfoArr];
        
        //创建控制器titles
        [strongSelf.titles removeAllObjects];
        [strongSelf.titles addObjectsFromArray:selectedInfoArr];

        [strongSelf setData];
    };
    
    [self.navigationController pushViewController:addInfoVC animated:NO];
    
    
}

- (NSMutableArray *)selectedLabsArr {
    if (!_selectedLabsArr) {
        _selectedLabsArr = [NSMutableArray array];
    }
    return _selectedLabsArr;
}

- (void)setData{
        if ([ZHFactory readPlistWithPlistName:@"infoLabels.plist"]) {//有缓存
            _titles = [[ZHFactory readPlistWithPlistName:@"infoLabels.plist"] objectForKey:kMyInfoArr];
        }else {//没缓存
            _titles = [NSMutableArray arrayWithArray:@[@"推荐",@"要闻",@"7*24小时",@"日历",]];
        }
    
}

- (NSMutableArray<NSString *> *)titles{

    if (!_titles) {
        [self setData];
    }

    return _titles;

}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

@end
