//
//  HDLeftMainViewController.m
//  HDStock
//
//  Created by liyancheng on 16/11/24.
//  Copyright © 2016年 hd-app02. All rights reserved.
//
//每次打开左视图 都要请求头像
#import "HDLeftMainViewController.h"
#import "AppDelegate.h"
#import "PersonalCenterFirstCell.h"
#import "PersonalCenterSecondCell.h"
#import "buttonOfFirstCell.h"
#import "ButtonOfPersonalTopView.h"
#import "SystemSettingViewController.h"//系统设置
#import "HDPersonInfoViewController.h"//个人信息
#import "guChiViewController.h"//我的股池
#import "MyCollectViewController.h"//我的收藏
#import "MyAskAndAnswerViewController.h"//我的问答
#import "MyCommentViewController.h"//我的评论
#import "MyAttentionViewController.h"//我的关注
#import "PersonalproductViewController.h"//产品
#import "PersonalJinnangViewController.h"//锦囊
#import "PCMyChatViewController.h"//我的聊天
#import "PCRegisterTelViewController.h"//注册电话号码界面
#import "PCSignInViewController.h"//登录界面
#define getAvatar @"http://test.cdtzb.com/api.php?mod=member&act=uploadavatar&type=get_head_pic&token="

@interface HDLeftMainViewController ()<UITableViewDataSource,UITableViewDelegate>

@property (nonatomic,strong) UITableView *tableview;

@end

@implementation HDLeftMainViewController{
    UILabel *numberLabel;
    UIButton * rightButton;
    UIButton * button2;
    UIButton * button1;
   
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    // Do any additional setup after loading the view.
    self.view.backgroundColor = BACKGROUNDCOKOR;
    UITableView *  tableview = [[UITableView alloc] init];
    self.tableview = tableview;
    tableview.frame = self.view.bounds;
    tableview.dataSource = self;
    tableview.delegate  = self;
    tableview.bounces = NO;
    tableview.separatorStyle = UITableViewCellSeparatorStyleNone;
    [tableview registerNib:[UINib nibWithNibName:@"PersonalCenterFirstCell" bundle:nil] forCellReuseIdentifier:@"PersonalCenterFirstCell"];
    [tableview registerNib:[UINib nibWithNibName:@"PersonalCenterSecondCell" bundle:nil] forCellReuseIdentifier:@"PersonalCenterSecondCell"];
    [self.view addSubview:tableview];
    
}

-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    NSDictionary *dic = [[LYCUserManager informationDefaultUser] getUserInfoDic];
    NSString *avatarStr = [NSString stringWithFormat:@"%@%@&%u",getAvatar,dic[PCUserToken],arc4random()%10000];
    if(dic[PCUserToken]){
        [[CDAFNetWork sharedMyManager] get:avatarStr params:nil success:^(id json) {
            NSString * avatarStr = [NSString stringWithFormat:@"http://%@",json[@"data"][0][@"file_path"]];
            NSDictionary *dic = [[LYCUserManager informationDefaultUser] getUserInfoDic];
            NSMutableDictionary *mutDic = [NSMutableDictionary dictionaryWithDictionary:dic];
            [mutDic setObject:avatarStr forKey:PCUserAvatar];
            [[LYCUserManager informationDefaultUser] loginWithDictionary:mutDic];
            if(![[LYCUserManager informationDefaultUser].defaultUser objectForKey:@"avatar"]){
                [[LYCUserManager informationDefaultUser] setAvatar:avatarStr];
            }
        } failure:^(NSError *error) {
            
        }];
    }
    
    [[LYCUserManager informationDefaultUser] getUserInformation];
    NSDictionary *dicd = [[LYCUserManager informationDefaultUser] getUserInfoDic];
    if([dicd[PCUserState] isEqualToString:@"登录成功"]){
        button1.hidden = YES;
        button2.hidden = YES;
        NSDictionary *dicdd = [[LYCUserManager informationDefaultUser] getUserInfoDic];
        dispatch_async(dispatch_get_main_queue(), ^{
            _imageView.image = [UIImage imageWithData:[[LYCUserManager informationDefaultUser].defaultUser objectForKey:@"avatar"]];
            if(dicdd[PCUserName]){
                _nameLabel.text = dicdd[PCUserName];
            }
        });
    }else{
        _nameLabel.text = @"未登录";
        button1.hidden = NO;
        button2.hidden = NO;
        _imageView.image = [UIImage imageNamed:@"weidenglu"];
    }
}



- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    if(section ==0){
        return 1;
    }else
    return 2;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    if(indexPath.section==0){
        PersonalCenterFirstCell *cell = [tableView dequeueReusableCellWithIdentifier:@"PersonalCenterFirstCell"];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        cell.buttonBlock = ^ (NSInteger index){
            [self handleFirstCellWithIndex:index];
        };
        
        return cell;
    }else if (indexPath.section ==1){
    PersonalCenterSecondCell *cell =[tableView dequeueReusableCellWithIdentifier:@"PersonalCenterSecondCell"];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        if(indexPath.row == 0){
            cell.titleLabel.text = @"五星好评";
            cell.leftImageView.image = [UIImage imageNamed:@"haoping"];
        }else if (indexPath.row == 1){
            cell.titleLabel.text = @"系统设置";
            cell.leftImageView.image = [UIImage imageNamed:@"xitongshezhi"];
        }
        
        return cell;
    }
    else{
        return nil;
    }
}

- (void)handleFirstCellWithIndex:(NSInteger)index{
    NSLog(@"%ld",(long)index);
    switch (index) {
        case 201:
        {
            [self presentTargetViewController:NSStringFromClass([PersonalproductViewController class])];
//            [self presentTargetViewController:NSStringFromClass([guChiViewController class])];
        }
            break;
            
        case 202:
        {
            
        }
            break;
            
        case 203:
        {
            [self presentTargetViewController:NSStringFromClass([MyAskAndAnswerViewController class])];
//            [self presentTargetViewController:NSStringFromClass([PCMyChatViewController class])];
        }
            break;
            
        case 204:
        {
            [self presentTargetViewController:NSStringFromClass([MyAttentionViewController class])];
            
        }
            break;
            
        case 205:
        {
            [self presentTargetViewController:NSStringFromClass([MyCollectViewController class])];
        }
            break;
            
        case 206:
        {
            [self presentTargetViewController:NSStringFromClass([MyCommentViewController class])];
        }
            break;
            
        default:
            break;
    }
}

- (void)presentTargetViewController:(NSString *)classStr{
    id targetVC = [[NSClassFromString(classStr) alloc] init];
    UINavigationController *nav = [[UINavigationController alloc]initWithRootViewController:targetVC];
    AppDelegate *delegate = (AppDelegate *)[UIApplication sharedApplication].delegate;
    [delegate.window.rootViewController presentViewController:nav animated:YES completion:nil];
    if([targetVC isKindOfClass:[PCSignInViewController class]]){
        PCSignInViewController *controller = targetVC;
        controller.blockd = ^{
            MBProgressHUD *hud = [MBProgressHUD showHUDAddedTo:self.view animated:YES];
            hud.mode = MBProgressHUDModeText;
            hud.label.text = @"修改密码成功";
            [hud hideAnimated:YES afterDelay: 1];
        };
    }
    
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
//    [tableView deselectRowAtIndexPath:indexPath animated:YES];
//    UITableViewCell *cell = [tableView cellForRowAtIndexPath:indexPath];
    if(indexPath.section ==0){
    
    }else if (indexPath.section ==1){
        if(indexPath.row == 0){
            
        }else if (indexPath.row == 1){
            SystemSettingViewController *setting = [[SystemSettingViewController alloc]init];
            UINavigationController *nav = [[UINavigationController alloc]initWithRootViewController:setting];
            
            AppDelegate *delegate = (AppDelegate *)[UIApplication sharedApplication].delegate;
            [delegate.window.rootViewController presentViewController:nav animated:YES completion:nil];
        }
    }
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section
{
    if (section==0) {
        return 255;
    }
    return 0;
}

- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section
{
    
    UIView *view = [[UIView alloc] initWithFrame:CGRectMake(0, 0, self.tableview.bounds.size.width, 255)];
    view.backgroundColor = RGBCOLOR(26, 120, 200);
    UIImageView *backGroudImage = [[UIImageView alloc]initWithFrame:view.frame];
    backGroudImage.userInteractionEnabled = YES;
    backGroudImage.image = [UIImage imageNamed:@"bigbg"];
    [view addSubview:backGroudImage];
    
    //登录
    button1 = [[UIButton alloc]initWithFrame:CGRectMake(CGRectGetMidX(view.frame)-115, CGRectGetMaxY(view.frame)-60, 90, 30)];
    [button1 setTitle:@"登录" forState:UIControlStateNormal];
    button1.tag = 201;
    [button1 setTitleColor:RGBCOLOR(21, 121, 202) forState:UIControlStateNormal];
    button1.backgroundColor = UICOLOR(255, 255, 255, 0.8);
    button1.cornerRadius = 3;
    button1.titleLabel.font = [UIFont systemFontOfSize:15];
   [button1 addTarget:self action:@selector(jumpToDetailByTag:) forControlEvents:UIControlEventTouchUpInside];
    
    //注册
    button2 = [[UIButton alloc]initWithFrame:CGRectMake(CGRectGetMidX(view.frame)+25, CGRectGetMaxY(view.frame)-60, 90, 30)];
    [button2 setTitle:@"注册" forState:UIControlStateNormal];
    [button2 setTitleColor:RGBCOLOR(21, 121, 202) forState:UIControlStateNormal];
    button2.backgroundColor = UICOLOR(255, 255, 255, 0.8);
    button2.cornerRadius = 3;
    button2.titleLabel.font = [UIFont systemFontOfSize:15];
    button2.tag = 202;
     [button2 addTarget:self action:@selector(jumpToDetailByTag:) forControlEvents:UIControlEventTouchUpInside];
    
    [backGroudImage addSubview:button1];
    [backGroudImage addSubview:button2];
    
    NSDictionary *infoDic = [[LYCUserManager informationDefaultUser]getUserInfoDic];
    
    
    NSDictionary *dicd = [[LYCUserManager informationDefaultUser] getUserInfoDic];
    
    UIImageView* imageViewBack = [[UIImageView alloc]initWithFrame:CGRectMake(view.width/2-37, 60, 74, 74)];
    imageViewBack.image = [UIImage imageNamed:@"touxiang_bg"];
    [backGroudImage addSubview:imageViewBack];
    
    //头像
    _imageView = [[UIImageView alloc]initWithFrame:CGRectMake(view.width/2-30, 67, 60, 60)];
    _imageView.layer.cornerRadius = 30;
    _imageView.layer.masksToBounds = YES;
    _imageView.userInteractionEnabled = YES;

    UITapGestureRecognizer * tap = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(personalDetail)];
    [_imageView addGestureRecognizer:tap];
    [backGroudImage addSubview:_imageView];
    
    
    //名字
    _nameLabel = [[UILabel alloc]initWithFrame:CGRectMake(view.width/2-100, CGRectGetMaxY(_imageView.frame)+10, 200, 14)];
    [backGroudImage addSubview:_nameLabel];
    
    _nameLabel.font = [UIFont systemFontOfSize:13];
    _nameLabel.textColor = [UIColor whiteColor];
    _nameLabel.textAlignment = NSTextAlignmentCenter;
    
    if([infoDic[PCUserState] isEqualToString:@"登录成功"]){
        _nameLabel.text = dicd[PCUserName];
        button1.hidden = YES;
        button2.hidden = YES;
    }else{
        _nameLabel.text = @"未登录";
    }
    //头像左设置
    UIButton * leftButton = [[UIButton alloc]initWithFrame:CGRectMake(CGRectGetMinX(_imageView.frame)-48, CGRectGetMidY(_imageView.frame)-8, 18, 18)];
    [backGroudImage addSubview:leftButton];
    [leftButton setImage:[UIImage imageNamed:@"gerenshezhi"] forState:UIControlStateNormal];
    //头像右聊天
    rightButton = [[UIButton alloc]initWithFrame:CGRectMake(CGRectGetMaxX(_imageView.frame)+30, CGRectGetMidY(_imageView.frame)-8, 18, 18)];
    [backGroudImage addSubview:rightButton];
    numberLabel = [[UILabel alloc]initWithFrame:CGRectMake(0, 0, 20, 30)];
    [rightButton addSubview:numberLabel];
    [rightButton setImage:[UIImage imageNamed:@"xiaoxizhongxin"] forState:UIControlStateNormal];
    numberLabel.font = [UIFont systemFontOfSize:9];
    numberLabel.textColor = [UIColor whiteColor];
    numberLabel.layer.cornerRadius = 5;
    numberLabel.layer.masksToBounds = YES;
    numberLabel.backgroundColor = RGBCOLOR(200,40,63);
    return view;
}

-(void)setNumberOfTalking:(NSInteger)numberOfTalking{
    _numberOfTalking = numberOfTalking;
    if(_numberOfTalking < 100){
        numberLabel.text = [NSString stringWithFormat:@" %ld ",(long)_numberOfTalking];
    }else{
        numberLabel.text = @" 99+ ";
    }
    [numberLabel sizeToFit];
    numberLabel.center = CGPointMake(CGRectGetWidth(rightButton.frame)*1.1, -CGRectGetHeight(numberLabel.frame)/2+6);
}

-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 2;
}

-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    if(indexPath.section ==0){
        return 165;
    }else return 40;
}

- (void)personalDetail{
    
    HDPersonInfoViewController *personInfo = [[HDPersonInfoViewController alloc]init];
    
    UINavigationController *nav = [[UINavigationController alloc]initWithRootViewController:personInfo];
    
    AppDelegate *delegate = (AppDelegate *)[UIApplication sharedApplication].delegate;
    
    [delegate.window.rootViewController presentViewController:nav animated:YES completion:nil];
}

- (void)jumpToDetailByTag:(UIButton *)sender{
    switch (sender.tag) {
        case 201:
            [self presentTargetViewController:NSStringFromClass([PCSignInViewController class])];
            break;
        case 202:
            [self presentTargetViewController:NSStringFromClass([PCRegisterTelViewController class])];
            break;
        case 203:
//            [self presentTargetViewController:NSStringFromClass([PersonalproductViewController class])];
            break;
            
        default:
            break;
    }
}


@end
