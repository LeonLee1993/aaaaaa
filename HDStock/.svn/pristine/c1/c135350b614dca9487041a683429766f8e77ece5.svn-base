//
//  LYCUserManager.m
//  meizai
//
//  Created by liyancheng on 16/5/9.
//  Copyright © 2016年 touzibao. All rights reserved.
//

#import "LYCUserManager.h"
#define resignStr @"http://test.cdtzb.com/api.php?mod=member&act=login"
#define getInformationStr  @"http://test.cdtzb.com/api.php?mod=member&act=profile&method=info"
@implementation LYCUserManager{
    
}

+(instancetype)informationDefaultUser{
    static dispatch_once_t onceToken;
    static LYCUserManager *instance = nil;
    dispatch_once(&onceToken,^{
        instance = [[self alloc]initA];
    });
    return instance;
}

- (instancetype)initA{
    if(self =[super init]){
        _defaultUser = [NSUserDefaults standardUserDefaults];
    }
    return self;
}

- (BOOL)isUserLogin {
    NSDictionary *dic =[_defaultUser objectForKey:PCUserKey];
    if ([dic[PCUserState] isEqualToString:@"登录成功"]) {
        return YES;
    }
    return NO;
}

- (void)loginWithDictionary:(NSDictionary *)dic{
    NSLog(@"%@",dic);
    [_defaultUser setObject:dic forKey:PCUserKey];
}


- (void)logOut {
    NSDictionary *dic =[_defaultUser objectForKey:PCUserKey];
    NSMutableDictionary *mutDic = [NSMutableDictionary dictionaryWithDictionary:dic];
    [mutDic removeAllObjects];
    [_defaultUser setObject:mutDic forKey:PCUserKey];
}

-(NSDictionary *)getUserInfoDic{
    NSDictionary *dic;
    if(![[_defaultUser objectForKey:PCUserKey]isKindOfClass:[NSNull class]]){
    
        dic = [_defaultUser objectForKey:PCUserKey];
    }
    return dic;
}

-(void)autoLogin{
    
    [self signInAction];
    
}

- (void)signInAction{
    NSDictionary * infoDicd = [self getUserInfoDic];
    NSString *url = resignStr;
    NSMutableDictionary *mutDic = @{}.mutableCopy;
    NSLog(@"%@",infoDicd);
    if([infoDicd[PCUserPassword] isKindOfClass:[NSNull class]]||[infoDicd[PCUserPhone] isKindOfClass:[NSNull class]]||infoDicd == nil||infoDicd.allKeys.count==0||[((NSString *)infoDicd[@"userName"]) isKindOfClass:[NSNull class]]||infoDicd.allKeys.count<2){
        NSLog(@"没得用户");
    }else{
        [mutDic setObject:infoDicd[PCUserPassword] forKey:@"password"];
        if([((NSString *)infoDicd[@"userName"]) isKindOfClass:[NSNull class]]){
            [mutDic setObject:@"" forKey:@"username"];
        }else{
            [mutDic setObject:infoDicd[PCUserPhone] forKey:@"username"];
        }
        AFHTTPSessionManager *manager = [AFHTTPSessionManager manager];
        manager.responseSerializer = [AFJSONResponseSerializer serializer];
        manager.responseSerializer.acceptableContentTypes = [NSSet setWithObjects:@"text/html", @"application/json", nil];
        [manager POST:url parameters:mutDic progress:^(NSProgress * _Nonnull uploadProgress) {
            
        } success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
            NSMutableDictionary *infoDic = @{}.mutableCopy;
            NSLog(@"%@",responseObject);
            if(((NSArray*)infoDic[@"data"]).count>0){
                [infoDic setObject:responseObject[@"msg"] forKey:PCUserState];
                [infoDic setObject:responseObject[@"data"][0][@"token"] forKey:PCUserToken];
                [infoDic setObject:infoDicd[PCUserName] forKey:PCUserName];
                [infoDic setObject:infoDicd[PCUserPassword] forKey:PCUserPassword];
                [infoDic setObject:infoDicd[PCUserPhone] forKey:PCUserPhone];
                [_defaultUser setObject:infoDic forKey:PCUserKey];
                
            }
            NSLog(@"%@",responseObject[@"msg"]);
            [self getUserInformation];
        } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
            NSLog(@"%@",error);
        }];
    }
}


#pragma mark --获得当前用户登录信息
- (void)getUserInformation{
    NSString *url = getInformationStr;
    [[CDAFNetWork sharedMyManager]get:url params:nil success:^(id json) {
        NSLog(@"%@",json);
        NSDictionary *dic = [self getUserInfoDic];
        NSMutableDictionary *mutDic = [NSMutableDictionary dictionaryWithDictionary:dic];
//        NSLog(@"%@",[json[@"data"][0][@"field1"] class]);
        if([json[@"data"][0][@"field1"] isKindOfClass:[NSNull class]]){
            NSLog(@"未返回用户名");
            [mutDic setObject:@"" forKey:PCUserName];
        }else{
            [mutDic setObject:json[@"data"][0][@"field1"] forKey:PCUserName];
        }
        [self loginWithDictionary:mutDic];
    } failure:^(NSError *error) {
        NSLog(@"error");
        NSLog(@"%@",error);
    }];
}


@end
